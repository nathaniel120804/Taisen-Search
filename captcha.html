<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Human Verification</title>
<style>
:root{--primary:#0077ff;--success:#28a745;--danger:#dc3545;--light:#f8f9fa;--dark:#343a40;--gray:#6c757d;--border-radius:8px;--box-shadow:0 4px 6px rgba(0,0,0,0.1);--transition:all 0.3s ease}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;color:var(--dark)}.container{width:100%;max-width:500px;margin:0 auto}.header{text-align:center;margin-bottom:30px}.header h1{font-size:2.5rem;margin-bottom:10px;color:var(--primary);display:flex;align-items:center;justify-content:center;gap:10px}.header p{font-size:1.1rem;color:var(--gray)}.card{background:white;border-radius:var(--border-radius);box-shadow:var(--box-shadow);padding:30px;margin-bottom:20px}.captcha-box{text-align:center}.captcha-header{margin-bottom:20px}.captcha-header h2{font-size:1.5rem;margin-bottom:5px;color:var(--dark)}.captcha-header p{color:var(--gray)}.captcha-display{background:var(--light);padding:20px;border-radius:var(--border-radius);margin-bottom:20px;border:1px solid #e9ecef}.captcha-question{font-size:2rem;font-weight:bold;margin-bottom:15px;color:var(--dark)}.captcha-input-container{display:flex;justify-content:center;margin-bottom:20px}.captcha-input{width:120px;padding:12px;font-size:1.2rem;text-align:center;border:2px solid #e9ecef;border-radius:var(--border-radius);transition:var(--transition)}.captcha-input:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(0,119,255,0.1)}.btn{padding:12px 24px;font-size:1rem;font-weight:600;border:none;border-radius:var(--border-radius);cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;justify-content:center;gap:8px}.btn-primary{background:var(--primary);color:white}.btn-primary:hover{background:#005fcc;transform:translateY(-2px)}.btn-secondary{background:var(--light);color:var(--dark);border:1px solid #dee2e6}.btn-secondary:hover{background:#e9ecef}.attempts-counter{margin-top:15px;font-size:0.9rem;color:var(--gray)}.status-message{padding:10px;border-radius:var(--border-radius);margin-top:15px;display:none}.status-success{background:rgba(40,167,69,0.1);color:var(--success);border:1px solid rgba(40,167,69,0.2)}.status-error{background:rgba(220,53,69,0.1);color:var(--danger);border:1px solid rgba(220,53,69,0.2)}.loading{display:none;text-align:center;margin:10px 0}.spinner{border:4px solid rgba(0,0,0,0.1);border-left-color:var(--primary);border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto}@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>🔒 Human Verification</h1>
    <p>Please verify you're human to continue</p>
  </div>

  <div class="card">
    <div class="captcha-box">
      <div class="captcha-header">
        <h2>CAPTCHA Challenge</h2>
        <p>Solve the challenge below</p>
      </div>
      <div class="captcha-display">
        <div class="captcha-question" id="captchaQuestion">Loading...</div>
        <div class="captcha-input-container">
          <input type="text" id="captchaAnswer" class="captcha-input" placeholder="?" autocomplete="off">
        </div>
        <div class="attempts-counter" id="attemptsCounter">Attempts: 0/3</div>
      </div>

      <div class="loading" id="loadingIndicator"><div class="spinner"></div><p>Verifying...</p></div>
      <div class="status-message" id="statusMessage"></div>

      <button id="verifyBtn" class="btn btn-primary"><span>Verify</span></button>
      <button id="refreshBtn" class="btn btn-secondary" style="margin-left:10px;"><span>Refresh</span></button>
    </div>
  </div>

  <div class="footer"><p>Taisen Security System &copy; 2025</p></div>
</div>

<script>
let challengeId = null, attempts = 0, maxAttempts = 3;

// Generate challenge by calling server
async function fetchCaptcha(){
  showLoading();
  const res = await fetch('/generate-captcha'); // SERVER endpoint
  const data = await res.json();
  challengeId = data.id;
  document.getElementById('captchaQuestion').textContent = data.question;
  document.getElementById('captchaAnswer').value='';
  hideStatusMessage();
  hideLoading();
}

// Verify challenge by sending answer to server
async function verifyCaptcha(){
  const answer = document.getElementById('captchaAnswer').value.trim();
  if(!answer){showStatusMessage('Enter an answer','error'); return;}
  attempts++; document.getElementById('attemptsCounter').textContent=`Attempts: ${attempts}/${maxAttempts}`;
  showLoading();
  const res = await fetch('/verify-captcha', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({id:challengeId, answer})
  });
  const result = await res.json();
  if(result.success){
    showStatusMessage('✓ Verification successful! Redirecting...','success');
    setTimeout(()=>window.location.href='results.html',1500);
  } else {
    if(attempts>=maxAttempts){
      showStatusMessage('❌ Too many failed attempts','error');
      setTimeout(()=>window.location.href='/',2000);
    } else {
      showStatusMessage('❌ Incorrect. Try again','error');
      setTimeout(fetchCaptcha,1500);
    }
  }
  hideLoading();
}

// UI helpers
function showStatusMessage(msg,type){const el=document.getElementById('statusMessage');el.textContent=msg;el.className=`status-message status-${type}`;el.style.display='block';}
function hideStatusMessage(){document.getElementById('statusMessage').style.display='none';}
function showLoading(){document.getElementById('loadingIndicator').style.display='block';document.getElementById('verifyBtn').disabled=true;document.getElementById('refreshBtn').disabled=true;}
function hideLoading(){document.getElementById('loadingIndicator').style.display='none';document.getElementById('verifyBtn').disabled=false;document.getElementById('refreshBtn').disabled=false;}

document.getElementById('verifyBtn').addEventListener('click',verifyCaptcha);
document.getElementById('refreshBtn').addEventListener('click',fetchCaptcha);
document.getElementById('captchaAnswer').addEventListener('keypress',e=>{if(e.key==='Enter')verifyCaptcha();});

// Initial fetch
fetchCaptcha();
</script>
</body>
</html>
