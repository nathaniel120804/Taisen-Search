<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Search Results - Taisen</title>
<link rel="icon" type="image/png" href="original.png">
<link rel="stylesheet" href="style.css?v=20250901">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script async src="https://cse.google.com/cse.js?cx=178f66b21f928448b"></script>

<style>
/* Modernized base styles from index.html */
:root {
  --primary: #0077ff;
  --primary-dark: #0056cc;
  --secondary: #6c757d;
  --success: #34a853;
  --danger: #d93025;
  --warning: #ffc107;
  --info: #17a2b8;
  --light: #f8f9fa;
  --dark: #343a40;
  --white: #ffffff;
  --gray-100: #f8f9fa;
  --gray-200: #e9ecef;
  --gray-300: #dee2e6;
  --gray-400: #ced4da;
  --gray-500: #adb5bd;
  --gray-600: #6c757d;
  --gray-700: #495057;
  --gray-800: #343a40;
  --gray-900: #212529;
  --gradient-primary: linear-gradient(135deg, #0077ff 0%, #0056cc 100%);
  --gradient-secondary: linear-gradient(135deg, #6c757d 0%, #495057 100%);
  --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
  --shadow-xl: 0 20px 25px rgba(0,0,0,0.15);
  --border-radius: 8px;
  --border-radius-lg: 12px;
  --transition: all 0.3s ease;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  color: var(--gray-800);
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Header - Applied index.html header styling */
header {
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow-sm);
  position: relative;
  z-index: 1000;
}

.hamburger {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  width: 24px;
  height: 18px;
  cursor: pointer;
  transition: var(--transition);
}

.hamburger div {
  height: 2px;
  background: var(--gray-700);
  border-radius: 2px;
  transition: var(--transition);
}

.hamburger:hover div {
  background: var(--primary);
}

.hamburger.active div:nth-child(1) {
  transform: rotate(45deg) translate(5px, 5px);
}

.hamburger.active div:nth-child(2) {
  opacity: 0;
}

.hamburger.active div:nth-child(3) {
  transform: rotate(-45deg) translate(7px, -6px);
}

/* Results-specific styling - KEEPING ALL ORIGINAL FUNCTIONALITY */
.results-header-inner {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
  display: flex;
  align-items: center;
  gap: 1.5rem;
  width: 100%;
}

.logo-link {
  display: flex;
  align-items: center;
}

.results-name {
  font-size: 1.75rem;
  font-weight: 700;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.searchbar-container {
  flex: 1;
  max-width: 600px;
}

.gsc-control-cse {
  padding: 0 !important;
  border: none !important;
  background: transparent !important;
}

.gsc-search-box {
  margin-bottom: 0 !important;
}

.gsc-input-box {
  border: 1px solid var(--gray-300) !important;
  border-radius: 24px !important;
  height: 44px !important;
  padding: 0 12px !important;
  background-color: var(--white) !important;
  transition: var(--transition);
  margin-right: 20px;
}

.gsc-input-box:hover, .gsc-input-box:focus-within {
  border-color: var(--primary) !important;
  box-shadow: 0 0 0 3px rgba(0, 119, 255, 0.1) !important;
}

.gsc-input {
  padding: 0 !important;
  font-size: 16px !important;
  color: var(--gray-800) !important;
  background-color: transparent !important;
}

.gsc-search-button {
  background-color: var(--primary) !important;
  border-color: var(--primary) !important;
  border-radius: 30px !important;
  padding: 8px 16px !important;
}
.gsc-webResult .gsc-result {
  padding: 20px !important;
  margin-bottom: 20px !important;
  background: blur 100px !important;
  border-radius: var(--border-radius-lg) !important;
  box-shadow: var(--shadow-md) !important;
  border: none !important;
  color: var(--gray-800) !important;
}
.gsc-webResult .gsc-result .gs-title {
  font-size: 18px !important;
  font-weight: bold !important;
  color: #a79595 !important;
}
/* Main Content - KEEPING ORIGINAL STRUCTURE */
.results-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 1.5rem 1rem;
  flex: 1;
  display: flex;
  gap: 2rem;
}

/* Controls Panel - Applied modern styling */
.controls-panel {
  flex: 0 0 250px;
  background: var(--white);
  border-radius: var(--border-radius-lg);
  padding: 1.5rem;
  height: fit-content;
  box-shadow: var(--shadow-md);
  transition: var(--transition);
}

.control-group {
  margin-bottom: 1.5rem;
}

.control-group h3 {
  font-size: 1.1rem;
  margin-bottom: 0.75rem;
  color: var(--gray-700);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* Toggle Styles - Modernized */
.toggle-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.toggle-label {
  font-weight: 500;
  color: var(--gray-700);
}

.switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
}

.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 24px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: var(--primary);
}

input:checked + .slider:before {
  transform: translateX(20px);
}

/* Filter Styles - Modernized */
.filter-container {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.filter-label {
  font-weight: 500;
  color: var(--gray-700);
}

select {
  padding: 0.5rem 0.75rem;
  border: 1px solid var(--gray-300);
  border-radius: var(--border-radius);
  background-color: var(--white);
  font-size: 0.9rem;
  color: var(--gray-800);
  cursor: pointer;
  transition: var(--transition);
}

select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 119, 255, 0.1);
}

/* Results Section - Modernized */
.results-section {
  flex: 1;
  width: 700px;
}

.results-header-info {
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--gray-300);
}

.results-count {
  font-size: 0.9rem;
  color: var(--gray-600);
}

.query-term {
  font-weight: 600;
  color: var(--primary);
}

/* Internal Results - Modernized */
.internal-results {
  margin-bottom: 2rem;
}

.section-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: var(--gray-700);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.result-card {
  background: var(--white);
  border-radius: var(--border-radius);
  padding: 1.25rem;
  margin-bottom: 1rem;
  box-shadow: var(--shadow-sm);
  border-left: 4px solid var(--primary);
  transition: var(--transition);
}

.result-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.result-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--primary);
}

.result-snippet {
  color: var(--gray-700);
  margin-bottom: 0.75rem;
  line-height: 1.5;
}

.result-meta {
  display: flex;
  gap: 1rem;
  font-size: 0.85rem;
  color: var(--gray-600);
}

.result-link {
  display: inline-block;
  margin-top: 0.5rem;
  font-weight: 500;
  color: var(--primary);
  transition: var(--transition);
}

.result-link:hover {
  color: var(--primary-dark);
  transform: translateX(3px);
}

.no-results {
  text-align: center;
  padding: 2rem;
  color: var(--gray-600);
  background: var(--gray-100);
  border-radius: var(--border-radius);
}

/* Google CSE Results - Modernized */
.gcse-searchresults-only {
  margin-top: 2rem;
}

.gsc-results {
  width: 100% !important;
}

.gsc-webResult .gs-title {
  font-size: 1.1rem !important;
  line-height: 1.4 !important;
  color: var(--primary) !important;
}

.gsc-webResult .gs-snippet {
  font-size: 0.95rem !important;
  line-height: 1.5 !important;
  color: var(--gray-700) !important;
}

.gsc-result {
  background-color: var(--white) !important;
  border-color: var(--gray-300) !important;
}

.gsc-table-result {
  color: var(--gray-800) !important;
}

/* User Button from index.html */
#userButton {
  padding: 10px 20px;
  background: var(--gradient-primary);
  color: var(--white);
  border: none;
  border-radius: 50px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
  box-shadow: var(--shadow-md);
  transition: var(--transition);
}

#userButton:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

/* Footer from index.html */
footer {
  padding: 20px;
  text-align: center;
  background: rgba(255, 255, 255, 0.8);
  margin-top: auto;
}

.footer-links a {
      color: var(--gray-500);
      text-decoration: none;
      margin: 0 8px;
      transition: var(--transition);
    }

.footer-links a:hover {
  color: var(--primary);
}

/* Knowledge Panel Styles */
.knowledge-panel {
  flex: 0 0 350px;
  background: var(--white);
  border-radius: var(--border-radius-lg);
  box-shadow: var(--shadow-md);
  overflow: hidden;
  position: sticky;
  top: 20px;
  max-height: 80vh;
  overflow-y: auto;
  display: none;
}

.knowledge-header {
  background: var(--gradient-primary);
  color: white;
  padding: 1.5rem;
}

.knowledge-title {
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.knowledge-subtitle {
  opacity: 0.9;
  font-size: 0.9rem;
}

.knowledge-body {
  padding: 1.5rem;
}

.knowledge-section {
  margin-bottom: 1.5rem;
}

.section-title {
  font-size: 1.1rem;
  margin-bottom: 0.75rem;
  color: var(--gray-700);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.knowledge-description {
  color: var(--gray-600);
  line-height: 1.5;
  margin-bottom: 1rem;
}

.fact-grid {
  display: grid;
  gap: 0.75rem;
}

.fact-item {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--gray-200);
}

.fact-label {
  font-weight: 500;
  color: var(--gray-700);
  font-size: 0.9rem;
}

.fact-value {
  color: var(--gray-600);
  text-align: right;
  font-size: 0.9rem;
  max-width: 200px;
}

.quick-actions {
  background: var(--gray-100);
  padding: 1rem;
  border-radius: var(--border-radius);
  margin-top: 1.5rem;
}

.action-buttons {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.action-button {
  padding: 0.5rem 1rem;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: var(--border-radius);
  cursor: pointer;
  font-size: 0.8rem;
  transition: var(--transition);
}

.action-button:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.action-button.secondary {
  background: var(--gray-600);
}

.action-button.secondary:hover {
  background: var(--gray-700);
}

/* NEW STYLES FOR AI RESPONSE TRUNCATION */
.ai-response {
  position: relative;
  overflow: hidden;
}

.ai-response.truncated {
  max-height: 200px;
}

.ai-response.truncated::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: linear-gradient(transparent, var(--white));
  pointer-events: none;
}

.read-more-btn {
  background: transparent;
  border: none;
  color: var(--primary);
  cursor: pointer;
  font-weight: 500;
  margin-top: 10px;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: var(--transition);
  padding: 8px 0;
}

.read-more-btn:hover {
  color: var(--primary-dark);
}

.read-more-btn i {
  transition: var(--transition);
}

.read-more-btn.expanded i {
  transform: rotate(180deg);
}

.account-button.analytics {
      background: var(--info);
      color: white;
    }

    .account-button.analytics:hover {
      background: #138496;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .gsc-adBlock, .gcsc-find-more-on-google { display: none !important; }

/* Loading indicator */
.loading-indicator {
  display: flex;
  justify-content: center;
  gap: 4px;
  margin: 20px 0;
}

.dot {
  width: 8px;
  height: 8px;
  background: var(--primary);
  border-radius: 50%;
  animation: bounce 1.4s infinite ease-in-out;
}

.dot:nth-child(2) {
  animation-delay: 0.2s;
}

.dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes bounce {
  0%, 80%, 100% { 
    transform: scale(0.8); 
    opacity: 0.5; 
  }
  40% { 
    transform: scale(1); 
    opacity: 1; 
  }
}

/* Knowledge Panel Scrollbar */
.knowledge-panel::-webkit-scrollbar {
  width: 6px;
}

.knowledge-panel::-webkit-scrollbar-track {
  background: var(--gray-100);
  border-radius: 3px;
}

.knowledge-panel::-webkit-scrollbar-thumb {
  background: var(--gray-400);
  border-radius: 3px;
}

.knowledge-panel::-webkit-scrollbar-thumb:hover {
  background: var(--gray-500);
}

/* Auth Modal Styles */
    .auth-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 10001;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .auth-modal.active {
      display: flex;
      animation: modalFadeIn 0.3s ease;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .auth-container {
      background: var(--white);
      border-radius: var(--border-radius-lg);
      width: 90%;
      max-width: 400px;
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      transform: scale(0.9);
      animation: modalScaleIn 0.3s ease forwards;
    }

    @keyframes modalScaleIn {
      to { transform: scale(1); }
    }

    .auth-header {
      padding: 25px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--gradient-primary);
      color: var(--white);
    }

    .auth-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }

    .auth-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--white);
      transition: var(--transition);
    }

    .auth-close:hover {
      transform: scale(1.1);
    }

    .auth-content {
      padding: 25px;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--gray-200);
      border-radius: var(--border-radius) var(--border-radius) 0 0;
      overflow: hidden;
    }

    .auth-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      background: none;
      border: none;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
      font-weight: 500;
      color: var(--gray-600);
    }

    .auth-tab.active {
      border-bottom: 3px solid var(--primary);
      color: var(--primary);
      background: rgba(0, 119, 255, 0.05);
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--gray-700);
    }

    .form-input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--gray-300);
      border-radius: var(--border-radius);
      box-sizing: border-box;
      transition: var(--transition);
      font-size: 16px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 119, 255, 0.1);
    }

    .auth-button {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 500;
      margin-top: 10px;
      transition: var(--transition);
      font-size: 16px;
    }

    .auth-button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .auth-button.google {
      background: #db4437;
    }

    .auth-button.google:hover {
      background: #c23321;
    }

    .auth-button.phone {
      background: #34a853;
    }

    .auth-button.phone:hover {
      background: #2d9248;
    }

    .auth-button.anonymous {
      background: var(--gray-600);
    }

    .auth-button.anonymous:hover {
      background: var(--gray-700);
    }

    .auth-divider {
      text-align: center;
      margin: 25px 0;
      position: relative;
    }

    .auth-divider::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--gray-300);
    }

    .auth-divider span {
      background: var(--white);
      padding: 0 15px;
      color: var(--gray-600);
      font-size: 14px;
    }

    .auth-error {
      color: var(--danger);
      font-size: 0.9rem;
      margin-top: 10px;
      display: none;
      padding: 8px 12px;
      background: rgba(217, 48, 37, 0.05);
      border-radius: var(--border-radius);
      border-left: 3px solid var(--danger);
    }

    .auth-error.active {
      display: block;
      animation: shake 0.5s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .auth-success {
      color: var(--success);
      font-size: 0.9rem;
      margin-top: 10px;
      display: none;
      padding: 8px 12px;
      background: rgba(52, 168, 83, 0.05);
      border-radius: var(--border-radius);
      border-left: 3px solid var(--success);
    }

    .auth-success.active {
      display: block;
    }
/* Account Modal Styles */
    .account-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 10002;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .account-modal.active {
      display: flex;
      animation: modalFadeIn 0.3s ease;
    }

    .account-container {
      background: var(--white);
      border-radius: var(--border-radius-lg);
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      transform: scale(0.9);
      animation: modalScaleIn 0.3s ease forwards;
    }

    .account-header {
      padding: 25px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--gradient-primary);
      color: var(--white);
    }

    .account-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }

    .account-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--white);
      transition: var(--transition);
    }

    .account-close:hover {
      transform: scale(1.1);
    }

    .account-content {
      padding: 25px;
    }

    .account-info {
      margin-bottom: 25px;
    }

    .account-info-item {
      margin-bottom: 15px;
      padding: 15px;
      background: var(--gray-100);
      border-radius: var(--border-radius);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }

    .account-info-item:hover {
      background: var(--gray-200);
      transform: translateX(5px);
    }

    .account-info-label {
      font-weight: 600;
      color: var(--gray-600);
    }

    .account-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .account-button {
      padding: 12px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }

    .account-button.signout {
      background: var(--danger);
      color: white;
    }

    .account-button.signout:hover {
      background: #c23321;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .account-button.manage {
      background: var(--primary);
      color: white;
    }

    .account-button.manage:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
@keyframes modalScaleIn {
  to { transform: scale(1); }
}

/* Taisen-Style Pagination - Synced with Design Guidelines */
.gsc-cursor-box {
  text-align: center;
  margin-top: 20px;
  padding: 20px;
  background: var(--white);
  border-radius: var(--border-radius-lg);
  box-shadow: var(--shadow-sm);
  transition: var(--transition);
  position: relative;
}

.gsc-cursor-box:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-1px);
}

/* Taisen Brand Header - Using Design System Colors */
.gsc-cursor-box::before {
  content: "Taaaaaaaaaisen";
  font-size: 1.75rem;
  font-weight: 700;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  display: block;
  margin-bottom: 15px;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  letter-spacing: -0.5px;
}

/* Page Numbers - Using Design System */
.gsc-cursor-page {
  color: var(--primary);
  font-size: 0.9rem;
  font-weight: 500;
  padding: 8px 12px;
  margin: 0 2px;
  text-decoration: none;
  background: var(--white);
  border-radius: var(--border-radius);
  border: 1px solid var(--gray-300);
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
}

/* Active Page - Using Primary Gradient */
.gsc-cursor-current-page {
  background: var(--gradient-primary);
  color: var(--white) !important;
  font-weight: 600;
  border: 1px solid var(--primary);
  box-shadow: var(--shadow-sm);
  transform: translateY(-1px);
}

/* Next Button - Consistent Styling */
.gsc-cursor-next-page {
  color: var(--primary);
  margin-left: 12px;
  text-decoration: none;
  font-weight: 500;
  padding: 8px 16px;
  background: var(--white);
  border-radius: var(--border-radius);
  border: 1px solid var(--gray-300);
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

/* Hover Effects - Consistent with Design System */
.gsc-cursor-page:hover,
.gsc-cursor-next-page:hover {
  color: var(--primary-dark);
  background: rgba(0, 119, 255, 0.05);
  border-color: var(--primary);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
  text-decoration: none;
}

/* Focus States for Accessibility */
.gsc-cursor-page:focus,
.gsc-cursor-next-page:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 119, 255, 0.1);
}

/* Responsive Design */
@media (max-width: 1024px) {
  .results-container {
    flex-direction: column;
  }
  
  .knowledge-panel {
    position: static;
    max-height: none;
    flex: none;
    width: 100%;
  }
}

@media (max-width: 768px) {
  .results-container {
    flex-direction: column;
    gap: 1.5rem;
  }
  
  .controls-panel {
    flex: none;
  }
  
  .results-header-inner {
    flex-direction: column;
    gap: 1rem;
  }
  
  .searchbar-container {
    width: 100%;
  }
  
  header {
    flex-direction: column;
    gap: 1rem;
    padding: 10px;
  }
  
  .gsc-cursor-box {
    padding: 15px;
  }
  
  .gsc-cursor-box::before {
    font-size: 1.5rem;
    margin-bottom: 12px;
  }
  
  .gsc-cursor-page,
  .gsc-cursor-next-page {
    padding: 6px 10px;
    font-size: 0.85rem;
    margin: 0 1px;
    min-width: 36px;
  }
}

/* Dark mode support from index.html */
@media (prefers-color-scheme: dark) {
  :root {
    --light: #1a1a1a;
    --dark: #f8f9fa;
    --white: #2d2d2d;
    --gray-100: #1a1a1a;
    --gray-200: #2d2d2d;
    --gray-300: #404040;
    --gray-400: #595959;
    --gray-500: #737373;
    --gray-600: #8c8c8c;
    --gray-700: #a6a6a6;
    --gray-800: #bfbfbf;
    --gray-900: #d9d9d9;
  }

  body {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    color: var(--gray-800);
  }

  header, footer {
    background: rgba(45, 45, 45, 0.95);
  }

  .results-name {
    background: linear-gradient(135deg, #4dabf7 0%, #339af0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .gsc-cursor-page,
  .gsc-cursor-next-page {
    background: var(--white);
    border-color: var(--gray-300);
    color: var(--primary);
  }
  
  .gsc-cursor-page:hover,
  .gsc-cursor-next-page:hover {
    background: rgba(0, 119, 255, 0.1);
    border-color: var(--primary);
  }
  
  .gsc-cursor-current-page {
    background: var(--gradient-primary);
    color: var(--white) !important;
  }
}
/* Taisen-Style Pagination - Synced with Design Guidelines */
.gsc-cursor-box {
  text-align: center;
  margin-top: 20px;
  padding: 20px;
  box-shadow: var(--shadow-sm);
  transition: var(--transition);
  position: relative;
}

.gsc-cursor-box:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-1px);
}

/* Taisen Brand Header - Using Design System Colors */
.gsc-cursor-box::before {
  content: "Taaaaaaaaaisen";
  font-size: 1.75rem;
  font-weight: 700;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  display: block;
  margin-bottom: 15px;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  letter-spacing: -0.5px;
}

/* Page Numbers - Using Design System */
.gsc-cursor-page {
  color: var(--primary);
  font-size: 0.9rem;
  font-weight: 500;
  padding: 8px 12px;
  margin: 0 2px;
  text-decoration: none;
  background: var(--white);
  border-radius: var(--border-radius);
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
}

/* Active Page - Using Primary Gradient */
.gsc-cursor-current-page {
  background: var(--gradient-primary);
  color: var(--white) !important;
  font-weight: 600;
  box-shadow: var(--shadow-sm);
  transform: translateY(-1px);
}

/* Next Button - Consistent Styling */
.gsc-cursor-next-page {
  color: var(--primary);
  margin-left: 12px;
  text-decoration: none;
  font-weight: 500;
  padding: 8px 16px;
  background: var(--white);
  border-radius: var(--border-radius);
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

/* Hover Effects - Consistent with Design System */
.gsc-cursor-page:hover,
.gsc-cursor-next-page:hover {
  color: var(--primary-dark);
  background: rgba(0, 119, 255, 0.05);
  border-color: var(--primary);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
  text-decoration: none;
}

/* Focus States for Accessibility */
.gsc-cursor-page:focus,
.gsc-cursor-next-page:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(0, 119, 255, 0.1);
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .gsc-cursor-box {
    padding: 15px;
  }
  
  .gsc-cursor-box::before {
    font-size: 1.5rem;
    margin-bottom: 12px;
  }
  
  .gsc-cursor-page,
  .gsc-cursor-next-page {
    padding: 6px 10px;
    font-size: 0.85rem;
    margin: 0 1px;
    min-width: 36px;
  }
}

/* Dark Mode Support */
@media (prefers-color-scheme: dark) {
  .gsc-cursor-box {
    border-color: var(--gray-300);
  }
  
  .gsc-cursor-page,
  .gsc-cursor-next-page {
    background: var(--white);
    color: var(--primary);
  }
  
  .gsc-cursor-page:hover,
  .gsc-cursor-next-page:hover {
    background: rgba(0, 119, 255, 0.1);
  }
  
  .gsc-cursor-current-page {
    background: var(--gradient-primary);
    color: var(--white) !important;
  }
}
/* Hide GCSE main tabs but keep refinement tabs */
.gsc-tabsArea {
    display: none !important;
}

/* GCSE Refinement Tabs Container - Taisen Design */
.taisen-refinements-container {
    background: var(--white);
    border-bottom: 1px solid var(--gray-300);
    position: sticky;
    top: 0;
    z-index: 999;
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.95);
    box-shadow: var(--shadow-sm);
}

/* Inner container for refinements */
.taisen-refinements-inner {
    max-width: 1200px;
    margin: 0 auto;
    padding: 16px 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}

/* Refinement chips - Uniform size containers */
.taisen-refinement-chip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 80px;
    height: 40px;
    padding: 0 20px;
    background: var(--white);
    border: 1px solid var(--gray-300);
    border-radius: 24px;
    color: var(--gray-700);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    box-shadow: var(--shadow-sm);
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    text-align: center;
    white-space: nowrap;
    flex-shrink: 0;
}

.taisen-refinement-chip:hover {
    color: var(--primary);
    border-color: var(--primary);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
    background: rgba(0, 119, 255, 0.03);
}

.taisen-refinement-chip.selected {
    background: var(--gradient-primary);
    color: var(--white);
    border-color: var(--primary);
    box-shadow: var(--shadow-md);
    font-weight: 600;
    transform: translateY(-1px);
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .taisen-refinements-inner {
        padding: 12px 16px;
        overflow-x: auto;
        white-space: nowrap;
        flex-wrap: nowrap;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    
    .taisen-refinements-inner::-webkit-scrollbar {
        display: none;
    }
    
    .taisen-refinement-chip {
        min-width: 70px;
        height: 36px;
        padding: 0 16px;
        font-size: 13px;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .taisen-refinements-container {
        background: rgba(45, 45, 45, 0.95);
        border-bottom-color: var(--gray-300);
    }
    
    .taisen-refinement-chip {
        background: var(--white);
        border-color: var(--gray-300);
        color: var(--gray-800);
    }
    
    .taisen-refinement-chip:hover {
        border-color: var(--primary);
        background: rgba(0, 119, 255, 0.05);
    }
    
    .taisen-refinement-chip.selected {
        background: var(--gradient-primary);
        color: var(--white);
    }
}

/* Focus states for accessibility */
.taisen-refinement-chip:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 119, 255, 0.1);
}

/* Remove default GCSE styling */
.gsc-above-wrapper-area {
    border: none !important;
    background: transparent !important;
    margin-bottom: 0 !important;
}

.gsc-adBlock {
    display: none !important;
}

/* Hide original refinement area but keep functionality */
.gsc-refinementsArea {
    display: none !important;
}
</style>
</head>
<body>

<!-- Header with index.html design -->
<header>
  
  <!-- Results header content maintained -->
  <div class="results-header-inner">
    <a href="index.html" class="logo-link">
      <h1 class="results-name">Taisen</h1>
    </a>
    <div class="searchbar-container">
      <div class="gcse-searchbox-only" data-resultsUrl="results.html" data-newWindow="false"></div>
    </div>
  </div>
  
  <!-- User Button -->
  <button id="userButton">Sign In</button>
</header>

<!-- Main content UNCHANGED -->
<main class="results-container">

  <!-- Results Section -->
  <section class="results-section">
    <div class="results-header-info">
      <p class="results-count">Search results for: <span class="query-term" id="queryTerm">Loading...</span></p>
    </div>

    <!-- AI Results -->
    <div id="taisen-ai-results"></div>

    <!-- Google CSE Results -->
    <div class="gcse-searchresults-only"></div>
  </section>

  <!-- Knowledge Panel -->
  <aside class="knowledge-panel" id="knowledgePanel">
    <!-- Knowledge panel will be populated by JavaScript -->
  </aside>
</main>

<!-- Footer from index.html -->
<footer class="Footer">
    <div class="footer-section">
      <nav class="footer-links">
        <a href="about.html">About</a>
        <a href="advertising.html">Advertising</a>
        <a href="help center.html">Help Center</a>
        <a href="labs.html">Labs</a>
        <a href="security.html">Security</a>
        <a href="TaisenSearch_Documentation.html">Documentation</a>
      </nav>
    </div>
  </footer>

<!-- Auth Modal from index.html -->
<div id="authModal" class="auth-modal">
  <div class="auth-container">
    <div class="auth-header">
      <h2 class="auth-title">Sign In to Taisen</h2>
      <button id="authClose" class="auth-close">&times;</button>
    </div>
    <div class="auth-content">
      <div class="auth-tabs">
        <button class="auth-tab active" data-tab="signin">Sign In</button>
        <button class="auth-tab" data-tab="signup">Sign Up</button>
      </div>
      
      <!-- Email/Password Form -->
      <form id="emailForm" class="auth-form active">
        <div class="form-group">
          <label class="form-label" for="email">Email</label>
          <input type="email" id="email" class="form-input" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label class="form-label" for="password">Password</label>
          <input type="password" id="password" class="form-input" placeholder="Your password">
        </div>
        <button type="submit" class="auth-button" id="emailSubmit">Sign In</button>
        <div id="emailError" class="auth-error"></div>
        <div id="emailSuccess" class="auth-success"></div>
        <div class="terms-agreement" style=" margin: 15px 0; padding: 10px; background: rgba(0, 119, 255, 0.05); border-radius: var(--border-radius); border-left: 3px solid var(--primary); font-size: 14px; line-height: 1.4; color: var(--gray-600); "> <label for="termsAgreement"> By signing in and signing up to our services, you agree to our <a href="terms.html" target="_blank" style="color: var(--primary); text-decoration: none;">Terms of Service</a> and <a href="privacy.html" target="_blank" style="color: var(--primary); text-decoration: none;">Privacy Policy</a> </label> </div>
      </form>
      
      <!-- Phone Form -->
      <form id="phoneForm" class="auth-form">
        <div class="form-group">
          <label class="form-label" for="phoneNumber">Phone Number</label>
          <input type="tel" id="phoneNumber" class="form-input" placeholder="+1 234 567 8900">
        </div>
        <div class="form-group" id="verificationCodeGroup" style="display: none;">
          <label class="form-label" for="verificationCode">Verification Code</label>
          <input type="text" id="verificationCode" class="form-input" placeholder="Enter code">
        </div>
        <button type="submit" class="auth-button phone" id="phoneSubmit">Send Code</button>
        <div id="phoneError" class="auth-error"></div>
        <div id="phoneSuccess" class="auth-success"></div>
      </form>
      
      <!-- Provider Buttons -->
      <div class="auth-divider"><span>or continue with</span></div>
      
      <button class="auth-button google" id="googleSignIn">Sign in with Google</button>
      <button class="auth-button anonymous" id="anonymousSignIn">Continue as Guest</button>
    </div>
  </div>
</div>

<!-- Account Modal from index.html -->
<div id="accountModal" class="account-modal">
  <div class="account-container">
    <div class="account-header">
      <h2 class="account-title">Taisen Account</h2>
      <button id="accountClose" class="account-close">&times;</button>
    </div>
    <div class="account-content">
      <div class="account-info">
        <div class="account-info-item">
          <span class="account-info-label">Display Name:</span>
          <span id="accountDisplayName">Loading...</span>
        </div>
        <div class="account-info-item">
          <span class="account-info-label">Email:</span>
          <span id="accountEmail">Loading...</span>
        </div>
        <div class="account-info-item">
          <span class="account-info-label">User ID:</span>
          <span id="accountUserId">Loading...</span>
        </div>
        <div class="account-info-item">
          <span class="account-info-label">Account Type:</span>
          <span id="accountType">Loading...</span>
        </div>
      </div>
      <div class="account-actions">
        <button class="account-button analytics" id="viewAnalytics">View My Analytics</button>
        <button class="account-button manage" id="manageAccount">Manage Account</button>
        <button class="account-button signout" id="signOutButton">Sign Out</button>
      </div>
    </div>
  </div>
</div>

<!-- ALL JAVASCRIPT FROM BOTH FILES COMBINED -->
<script>
// Enhanced theme detection and application
function applyTheme() {
  const savedTheme = localStorage.getItem('theme');
  const body = document.body;
  
  // Remove any existing theme classes
  body.classList.remove('light', 'dark', 'auto-theme');
  
  if (savedTheme === 'light' || savedTheme === 'dark') {
    // Use saved preference
    body.classList.add(savedTheme);
  } else {
    // Auto-detect based on device preference
    body.classList.add('auto-theme');
    
    // Also check if we need to set a default for first-time visitors
    if (!localStorage.getItem('theme')) {
      localStorage.setItem('theme', 'auto');
    }
  }
}

// CAPTCHA Verification Function
function verifyCaptcha() {
  const params = new URLSearchParams(window.location.search);
  const query = params.get('q') || '';
  
  // Check both session and local storage
  const sessionVerify = JSON.parse(sessionStorage.getItem('captchaVerified') || 'null');
  const localVerify = JSON.parse(localStorage.getItem('captchaVerified') || 'null');
  const verification = sessionVerify || localVerify;
  
  // Validation checks
  if (!verification || !verification.verified) {
    redirectToCaptcha(query);
    return false;
  }
  
  // Check timestamp (expire after 2 hours)
  const twoHours = 2 * 60 * 60 * 1000;
  if (Date.now() - verification.timestamp > twoHours) {
    redirectToCaptcha(query);
    return false;
  }
  
  return true;
}

function redirectToCaptcha(query) {
  sessionStorage.removeItem('captchaVerified');
  localStorage.removeItem('captchaVerified');
  window.location.href = `captcha.html?q=${encodeURIComponent(query)}`;
}

// Listen for system theme changes
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'auto' || !savedTheme) {
    applyTheme();
  }
});

// Wikipedia Knowledge Panel Integration
class TAISEN_KnowledgePanel {
    constructor() {
        this.panel = document.getElementById('knowledgePanel');
        this.isProcessing = false;
    }

    async fetchData(query) {
        if (this.isProcessing) return;
        
        this.isProcessing = true;
        this.showLoading();

        try {
            // Search Wikipedia for the page
            const searchData = await this.searchWikipedia(query);
            if (!searchData || !searchData.query || !searchData.query.search.length) {
                this.showNoResults();
                return;
            }

            const pageTitle = searchData.query.search[0].title;
            
            // Get page content and extract
            const pageData = await this.getPageData(pageTitle);
            
            // Get Wikidata structured data
            const wikidataInfo = await this.getWikidataInfo(pageTitle);
            
            // Display the knowledge panel
            this.displayKnowledgePanel(pageTitle, pageData, wikidataInfo);
            
        } catch (error) {
            console.error('Knowledge Panel Error:', error);
            this.showError();
        } finally {
            this.isProcessing = false;
        }
    }

    async searchWikipedia(query) {
        const url = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*`;
        const response = await fetch(url);
        return await response.json();
    }

    async getPageData(pageTitle) {
        const url = `https://en.wikipedia.org/w/api.php?action=query&prop=extracts|pageimages|info&exintro=true&explaintext=true&pithumbsize=400&titles=${encodeURIComponent(pageTitle)}&format=json&origin=*`;
        const response = await fetch(url);
        const data = await response.json();
        
        const pageId = Object.keys(data.query.pages)[0];
        return data.query.pages[pageId];
    }

    async getWikidataInfo(pageTitle) {
        try {
            // Get Wikidata ID
            const propsUrl = `https://en.wikipedia.org/w/api.php?action=query&prop=pageprops&titles=${encodeURIComponent(pageTitle)}&format=json&origin=*`;
            const propsResponse = await fetch(propsUrl);
            const propsData = await propsResponse.json();
            
            const pageId = Object.keys(propsData.query.pages)[0];
            const wikidataId = propsData.query.pages[pageId].pageprops?.wikibase_item;
            
            if (!wikidataId) return null;

            // Get Wikidata entity data
            const wikidataUrl = `https://www.wikidata.org/wiki/Special:EntityData/${wikidataId}.json`;
            const wdResponse = await fetch(wikidataUrl);
            const wdData = await wdResponse.json();
            
            return wdData.entities[wikidataId];
        } catch (error) {
            console.error('Wikidata fetch error:', error);
            return null;
        }
    }

    showLoading() {
        this.panel.innerHTML = `
            <div class="knowledge-header">
                <div class="knowledge-title">Loading Knowledge Panel</div>
                <div class="knowledge-subtitle">Fetching information from Wikipedia</div>
            </div>
            <div class="knowledge-body">
                <div class="loading-indicator">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        `;
        this.panel.style.display = 'block';
    }

    showNoResults() {
        this.panel.innerHTML = `
            <div class="knowledge-header">
                <div class="knowledge-title">No Knowledge Panel Available</div>
                <div class="knowledge-subtitle">Try a different search term</div>
            </div>
            <div class="knowledge-body">
                <p>We couldn't find structured information for this search term in Wikipedia.</p>
            </div>
        `;
        this.panel.style.display = 'block';
    }

    showError() {
        this.panel.innerHTML = `
            <div class="knowledge-header">
                <div class="knowledge-title">Error Loading Knowledge Panel</div>
                <div class="knowledge-subtitle">Please try again later</div>
            </div>
            <div class="knowledge-body">
                <p>There was an error fetching information from Wikipedia. Please check your connection and try again.</p>
            </div>
        `;
        this.panel.style.display = 'block';
    }

    displayKnowledgePanel(pageTitle, pageData, wikidataInfo) {
        const extract = pageData.extract ? pageData.extract.substring(0, 300) + '...' : 'No description available.';
        const thumbnail = pageData.thumbnail ? pageData.thumbnail.source : null;
        
        // Extract basic info from Wikidata if available
        let structuredInfo = this.extractStructuredInfo(wikidataInfo);

        this.panel.innerHTML = `
            <div class="knowledge-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    ${thumbnail ? `<img src="${thumbnail}" alt="${pageTitle}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;">` : ''}
                    <div>
                        <div class="knowledge-title">${pageTitle}</div>
                        <div class="knowledge-subtitle">Wikipedia</div>
                    </div>
                </div>
            </div>

            <div class="knowledge-body">
                <div class="knowledge-section">
                    <div class="section-title">
                        <i class="fas fa-book"></i> Description
                    </div>
                    <p class="knowledge-description">${extract}</p>
                    <a href="https://en.wikipedia.org/wiki/${encodeURIComponent(pageTitle)}" target="_blank" style="color: var(--primary); text-decoration: none; font-size: 14px; font-weight: 500;">Read more on Wikipedia →</a>
                </div>

                ${structuredInfo ? `
                <div class="knowledge-section">
                    <div class="section-title">
                        <i class="fas fa-info-circle"></i> Key Facts
                    </div>
                    <div class="fact-grid">
                        ${structuredInfo.map(fact => `
                            <div class="fact-item">
                                <span class="fact-label">${fact.label}:</span>
                                <span class="fact-value">${fact.value}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="quick-actions">
                    <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--gray-700);">Quick Actions</h4>
                    <div class="action-buttons">
                        <button class="action-button" onclick="window.open('https://en.wikipedia.org/wiki/${encodeURIComponent(pageTitle)}', '_blank')">
                            Open Wikipedia
                        </button>
                        <button class="action-button secondary" onclick="window.open('https://www.google.com/search?q=${encodeURIComponent(pageTitle)}', '_blank')">
                            Google Search
                        </button>
                    </div>
                </div>
            </div>
        `;
        this.panel.style.display = 'block';
    }

    extractStructuredInfo(wikidataInfo) {
        if (!wikidataInfo || !wikidataInfo.claims) return null;

        const facts = [];
        
        // Extract common properties
        const propertyMap = {
            'P571': 'Founded',
            'P159': 'Headquarters',
            'P112': 'Founders',
            'P169': 'CEO',
            'P2139': 'Revenue',
            'P1128': 'Employees',
            'P17': 'Country',
            'P571': 'Inception',
        };

        for (const [property, label] of Object.entries(propertyMap)) {
            if (wikidataInfo.claims[property]) {
                const claim = wikidataInfo.claims[property][0];
                if (claim.mainsnak && claim.mainsnak.datavalue) {
                    let value = this.formatWikidataValue(claim.mainsnak.datavalue);
                    if (value) {
                        facts.push({ label, value });
                    }
                }
            }
        }

        return facts.length > 0 ? facts : null;
    }

    formatWikidataValue(datavalue) {
        try {
            if (datavalue.type === 'time') {
                return datavalue.value.time.substring(1, 11); // Extract date from timestamp
            } else if (datavalue.type === 'string') {
                return datavalue.value;
            } else if (datavalue.type === 'wikibase-entityid') {
                return 'Entity'; // For entities, you could fetch the label, but keeping it simple
            }
        } catch (error) {
            console.error('Error formatting Wikidata value:', error);
        }
        return null;
    }
}

// AI GPT Search Integration for Results Page - WITH QUERY FILTERING
class TAISEN_AIResults {
    constructor() {
        this.API_KEY = '4344c369928a4a26997e233f39cce26d';
        this.API_URL = 'https://api.aimlapi.com/v1/chat/completions';
        this.MODEL = 'google/gemma-3-12b-it';
        this.aiResultsContainer = null;
        this.isProcessing = false;
        this.MAX_VISIBLE_LENGTH = 800;
    }

    init() {
        this.createAIContainer();
        this.processCurrentSearch();
        this.overrideResultsSearch();
    }

    createAIContainer() {
        this.aiResultsContainer = document.getElementById('taisen-ai-results');
    }

    processCurrentSearch() {
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q');
        if (query && query.trim() !== "") {
            setTimeout(() => {
                this.showAIResults(query);
            }, 1000);
        }
    }

    overrideResultsSearch() {
        const interval = setInterval(() => {
            if (window.google && google.search && google.search.cse) {
                const searchBox = google.search.cse.element.getElement("gcse-searchbox-only");
                if (searchBox && searchBox.execute) {
                    clearInterval(interval);
                    
                    const originalExecute = searchBox.execute.bind(searchBox);
                    searchBox.execute = (query) => {
                        if (query && query.trim() !== "") {
                            setTimeout(() => {
                                this.showAIResults(query);
                            }, 1000);
                        }
                        originalExecute(query);
                    };
                }
            }
        }, 100);
    }

    // NEW: Query pattern detection for AI mode
    shouldShowAIResults(query) {
        const lowerQuery = query.toLowerCase().trim();
        
        // Patterns that SHOULD trigger AI results
        const aiPatterns = [
            // How-to and step-by-step questions
            /^how to\b/i,
            /^how do i\b/i,
            /^how can i\b/i,
            /^steps to\b/i,
            /^guide to\b/i,
            /^tutorial on\b/i,
            
            // Explanations and definitions
            /^what is\b/i,
            /^what are\b/i,
            /^explain\b/i,
            /^definition of\b/i,
            /^meaning of\b/i,
            
            // Comparisons
            /\bvs\b|\bversus\b/i,
            /\bcompared to\b/i,
            /\bpros and cons\b/i,
            /\badvantages and disadvantages\b/i,
            /\bdifferences between\b/i,
            
            // Summaries
            /^summary of\b/i,
            /^overview of\b/i,
            /^brief on\b/i,
            
            // Predictive and creative queries
            /^ideas for\b/i,
            /^suggestions for\b/i,
            /^best ways to\b/i,
            /^creative\b/i,
            /^brainstorm\b/i
        ];

        // Patterns that should NOT trigger AI results
        const nonAIPatterns = [
            // Local searches
            /\bnear me\b/i,
            /\bclose to me\b/i,
            /\bin my area\b/i,
            /\blocal\b/i,
            
            // Transactional searches
            /^buy\b/i,
            /^purchase\b/i,
            /^shop\b/i,
            /^price of\b/i,
            /^cost of\b/i,
            /^order\b/i,
            
            // Specific factual queries
            /^population of\b/i,
            /^capital of\b/i,
            /^height of\b/i,
            /^weight of\b/i,
            /^age of\b/i,
            /^when was\b/i,
            /^where is\b/i
        ];

        // Check if query matches any non-AI patterns first
        for (const pattern of nonAIPatterns) {
            if (pattern.test(lowerQuery)) {
                return false;
            }
        }

        // Check if query matches any AI patterns
        for (const pattern of aiPatterns) {
            if (pattern.test(lowerQuery)) {
                return true;
            }
        }

        // For queries that don't match clear patterns, use length and complexity as fallback
        const words = lowerQuery.split(/\s+/).length;
        return words >= 3; // Show AI for more complex queries (3+ words)
    }

    async showAIResults(query) {
        if (this.isProcessing) return;
        
        // Check if this query should trigger AI mode
        if (!this.shouldShowAIResults(query)) {
            this.hideAIResults();
            return;
        }
        
        this.isProcessing = true;
        this.showLoadingState(query);

        try {
            const aiResponse = await this.fetchAIResponse(query);
            this.displayAIResults(query, aiResponse);
        } catch (error) {
            console.error('AI Search Error:', error);
            this.hideAIResults();
        } finally {
            this.isProcessing = false;
        }
    }

    showLoadingState(query) {
        this.aiResultsContainer.innerHTML = `
            <div class="result-card">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; color: var(--primary); font-weight: 600; font-size: 18px;">
                    <span>🤖 TAISEN AI</span>
                    <div style="display: flex; gap: 4px;">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
                <div style="color: var(--gray-800); margin-bottom: 10px; font-weight: 500;">
                    Generating AI overview for: "${query}"
                </div>
            </div>
        `;
    }

    async fetchAIResponse(query) {
        const requestBody = {
            model: this.MODEL,
            messages: [
                {
                    role: "user",
                    content: `Provide a comprehensive, well-structured answer about: ${query}. Use clear paragraphs, bullet points with emojis, and keep it informative yet concise (under 400 words). Focus on key facts and insights.`
                }
            ],
            temperature: 0.2,
            top_p: 0.7,
            frequency_penalty: 1,
            max_tokens: 1536,
            top_k: 50
        };

        const response = await fetch(this.API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.API_KEY}`
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        return data.choices[0].message.content;
    }

    displayAIResults(query, aiResponse) {
        const needsTruncation = aiResponse.length > this.MAX_VISIBLE_LENGTH;
        const truncatedResponse = needsTruncation ? 
            aiResponse.substring(0, this.MAX_VISIBLE_LENGTH) + '...' : 
            aiResponse;
        
        this.aiResultsContainer.innerHTML = `
            <div class="result-card">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; color: var(--primary); font-weight: 600; font-size: 18px;">
                    <span>🤖</span>
                    <span>TAISEN AI Overview</span>
                </div>
                
                <div style="color: var(--gray-800); margin-bottom: 15px; font-weight: 500; font-size: 16px; padding: 10px; background: var(--gray-100); border-radius: var(--border-radius);">
                    ${query}
                </div>
                
                <div class="ai-response ${needsTruncation ? 'truncated' : ''}" style="color: var(--gray-700); line-height: 1.6; font-size: 15px; margin-bottom: 15px; white-space: pre-wrap; word-wrap: break-word;">
                    ${needsTruncation ? truncatedResponse : aiResponse}
                </div>
                
                ${needsTruncation ? `
                <button class="read-more-btn" data-full-response="${aiResponse.replace(/"/g, '&quot;')}">
                    <span>Read more</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                ` : ''}
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--gray-300); color: var(--gray-600); font-size: 13px; display: flex; justify-content: space-between; align-items: center;">
                    <span>🤖 AI-powered search (Gemma-3-12b) • May include inaccuracies</span>
                </div>
            </div>
        `;

        if (needsTruncation) {
            const readMoreBtn = this.aiResultsContainer.querySelector('.read-more-btn');
            readMoreBtn.addEventListener('click', this.toggleReadMore.bind(this));
        }
    }

    toggleReadMore(event) {
        const button = event.target.closest('.read-more-btn');
        const aiResponseElement = button.previousElementSibling;
        const isExpanded = button.classList.contains('expanded');
        
        if (isExpanded) {
            const truncatedResponse = button.getAttribute('data-full-response').substring(0, this.MAX_VISIBLE_LENGTH) + '...';
            aiResponseElement.textContent = truncatedResponse;
            aiResponseElement.classList.add('truncated');
            button.innerHTML = '<span>Read more</span><i class="fas fa-chevron-down"></i>';
            button.classList.remove('expanded');
        } else {
            const fullResponse = button.getAttribute('data-full-response');
            aiResponseElement.textContent = fullResponse;
            aiResponseElement.classList.remove('truncated');
            button.innerHTML = '<span>Read less</span><i class="fas fa-chevron-up"></i>';
            button.classList.add('expanded');
        }
    }

    hideAIResults() {
        this.aiResultsContainer.innerHTML = '';
    }
}

// Original code below - with UI integration
let data = [];

// Helpers
function getQuery() {
    const query = new URLSearchParams(window.location.search).get('q') || '';
    document.getElementById('queryTerm').textContent = query;
    return query;
}

function getLabsPreference() {
    const saved = localStorage.getItem('showLabs');
    return saved === null ? true : saved === 'true';
}

function saveLabsPreference(value) {
    localStorage.setItem('showLabs', value);
}

// Load internal JSON data
async function loadData() {
  // Apply theme first
  applyTheme();
  
  // CAPTCHA Verification Check
  if (!verifyCaptcha()) {
    return; // Redirect will happen automatically
  }

  const response = await fetch('taisenData.json');
  data = await response.json();

  const labsToggle = document.getElementById('labsToggle');
  const filterEl = document.getElementById('filter');

  // Initialize toggle from localStorage
  labsToggle.checked = getLabsPreference();

  function updateResults() {
    const showLabs = labsToggle.checked;
    const label = filterEl.value;
    const query = getQuery();

    let resultsDiv = document.getElementById('results-internal');
    const sectionTitle = document.querySelector('.internal-results .section-title');

    if (!showLabs) {
      // If toggle OFF, hide internal results completely
      resultsDiv.innerHTML = '';
      sectionTitle.style.display = 'none';
      return;
    }
    
    sectionTitle.style.display = 'flex';

    // Filter results based on query & label
    const filtered = data.filter(item => {
      const matchesQuery = item.title.toLowerCase().includes(query.toLowerCase()) ||
                           item.snippet.toLowerCase().includes(query.toLowerCase());
      const matchesLabel = label === 'all' || item.label === label;
      return matchesQuery && matchesLabel;
    });

    // Display
    resultsDiv.innerHTML = '';
    if (!filtered.length) {
      resultsDiv.innerHTML = `
        <div class="no-results">
          <p>No internal results found for your search.</p>
          <p>Try adjusting your search terms or changing the category filter.</p>
        </div>
      `;
      return;
    }
    
    filtered.forEach(item => {
      const card = document.createElement('div');
      card.className = 'result-card';
      card.innerHTML = `
        <h3 class="result-title">${item.title}</h3>
        <p class="result-snippet">${item.snippet}</p>
        <div class="result-meta">
          <span><strong>Type:</strong> ${item.type}</span>
          <span><strong>Source:</strong> ${item.source}</span>
        </div>
        <a href="${item.link}" target="_blank" class="result-link">Visit Resource →</a>
      `;
      resultsDiv.appendChild(card);
    });
  }

  // Event listeners
  labsToggle.addEventListener('change', () => {
    saveLabsPreference(labsToggle.checked);
    updateResults();
  });
  
  filterEl.addEventListener('change', updateResults);

  // Initial display
  updateResults();
}

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', () => {
    // Initialize Knowledge Panel
    const knowledgePanel = new TAISEN_KnowledgePanel();
    
    // Initialize AI Results
    const aiResults = new TAISEN_AIResults();
    aiResults.init();
    
    // Load internal data
    loadData();
    
    // Override Google CSE to sync with knowledge panel
    const interval = setInterval(() => {
        if (window.google && google.search && google.search.cse) {
            const searchBox = google.search.cse.element.getElement("gcse-searchbox-only");
            if (searchBox && searchBox.execute) {
                clearInterval(interval);
                
                const originalExecute = searchBox.execute.bind(searchBox);
                searchBox.execute = (query) => {
                    if (query && query.trim() !== "") {
                        // Update query term
                        document.getElementById('queryTerm').textContent = query;
                        
                        // Fetch knowledge panel data
                        knowledgePanel.fetchData(query);
                    }
                    originalExecute(query);
                };
            }
        }
    }, 100);
});

// Set initial query from URL
window.addEventListener('load', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');
    if (query) {
        document.getElementById('queryTerm').textContent = query;
        
        // Initialize knowledge panel with initial query
        const knowledgePanel = new TAISEN_KnowledgePanel();
        knowledgePanel.fetchData(query);
    }
});
</script>

<!-- AUTHENTICATION SCRIPT FROM INDEX.HTML -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged, 
    GoogleAuthProvider, 
    signInWithPopup, 
    signOut,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signInAnonymously,
    RecaptchaVerifier,
    signInWithPhoneNumber
  } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
  import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCMy4SNOU3eAl4iSfbmHWTxae9pVcnJFmc",
    authDomain: "taisen-search-ad9eb.firebaseapp.com",
    projectId: "taisen-search-ad9eb",
    storageBucket: "taisen-search-ad9eb.appspot.com",
    messagingSenderId: "779736719927",
    appId: "1:779736719927:web:07ccea945f7549ad56d5b2"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();
  
  // DOM Elements
  const userButton = document.getElementById("userButton");
  const authModal = document.getElementById("authModal");
  const accountModal = document.getElementById("accountModal");
  const authClose = document.getElementById("authClose");
  const accountClose = document.getElementById("accountClose");
  const authTabs = document.querySelectorAll(".auth-tab");
  const emailForm = document.getElementById("emailForm");
  const phoneForm = document.getElementById("phoneForm");
  const emailSubmit = document.getElementById("emailSubmit");
  const phoneSubmit = document.getElementById("phoneSubmit");
  const googleSignIn = document.getElementById("googleSignIn");
  const anonymousSignIn = document.getElementById("anonymousSignIn");
  const emailError = document.getElementById("emailError");
  const phoneError = document.getElementById("phoneError");
  const emailSuccess = document.getElementById("emailSuccess");
  const phoneSuccess = document.getElementById("phoneSuccess");
  const verificationCodeGroup = document.getElementById("verificationCodeGroup");
  const signOutButton = document.getElementById("signOutButton");
  const manageAccount = document.getElementById("manageAccount");
  const viewAnalytics = document.getElementById("viewAnalytics");
  
  // Account modal elements
  const accountDisplayName = document.getElementById("accountDisplayName");
  const accountEmail = document.getElementById("accountEmail");
  const accountUserId = document.getElementById("accountUserId");
  const accountType = document.getElementById("accountType");
  
  let confirmationResult = null;
  let isSignUp = false;

  // Modal Functions
  function openAuthModal() {
    authModal.classList.add("active");
    resetForms();
  }

  function closeAuthModal() {
    authModal.classList.remove("active");
    resetForms();
  }

  function openAccountModal() {
    accountModal.classList.add("active");
    updateAccountInfo();
  }

  function closeAccountModal() {
    accountModal.classList.remove("active");
  }

  function resetForms() {
    // Reset all forms and errors
    document.getElementById("email").value = "";
    document.getElementById("password").value = "";
    document.getElementById("phoneNumber").value = "";
    document.getElementById("verificationCode").value = "";
    
    emailError.textContent = "";
    phoneError.textContent = "";
    emailSuccess.textContent = "";
    phoneSuccess.textContent = "";
    
    emailError.classList.remove("active");
    phoneError.classList.remove("active");
    emailSuccess.classList.remove("active");
    phoneSuccess.classList.remove("active");
    
    verificationCodeGroup.style.display = "none";
    phoneSubmit.textContent = "Send Code";
    isSignUp = false;
  }

  function showError(element, message) {
    element.textContent = message;
    element.classList.add("active");
  }

  function showSuccess(element, message) {
    element.textContent = message;
    element.classList.add("active");
  }

  function updateAccountInfo() {
    const user = auth.currentUser;
    if (user) {
      accountDisplayName.textContent = user.displayName || "Not set";
      accountEmail.textContent = user.email || "No email";
      accountUserId.textContent = user.uid.substring(0, 8) + "...";
      accountType.textContent = user.isAnonymous ? "Guest Account" : "Full Account";
    }
  }

  // Tab Switching
  authTabs.forEach(tab => {
    tab.addEventListener("click", () => {
      const targetTab = tab.getAttribute("data-tab");
      
      // Update active tab
      authTabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      
      // Update forms based on tab
      if (targetTab === "signin") {
        emailSubmit.textContent = "Sign In";
        isSignUp = false;
      } else {
        emailSubmit.textContent = "Sign Up";
        isSignUp = true;
      }
    });
  });

  // Email/Password Authentication
  emailForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    
    if (!email || !password) {
      showError(emailError, "Please fill in all fields");
      return;
    }
    
    try {
      if (isSignUp) {
        // Sign up with email/password
        await createUserWithEmailAndPassword(auth, email, password);
        showSuccess(emailSuccess, "Account created successfully!");
        setTimeout(closeAuthModal, 1500);
      } else {
        // Sign in with email/password
        await signInWithEmailAndPassword(auth, email, password);
        showSuccess(emailSuccess, "Signed in successfully!");
        setTimeout(closeAuthModal, 1500);
      }
    } catch (error) {
      console.error("Email auth error:", error);
      showError(emailError, error.message);
    }
  });

  // Phone Authentication
  phoneForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const phoneNumber = document.getElementById("phoneNumber").value;
    const verificationCode = document.getElementById("verificationCode").value;
    
    if (!phoneNumber) {
      showError(phoneError, "Please enter a phone number");
      return;
    }
    
    try {
      if (!confirmationResult) {
        // First step: Send verification code
        const appVerifier = new RecaptchaVerifier(auth, 'phoneSubmit', {
          'size': 'invisible'
        });
        
        confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
        verificationCodeGroup.style.display = "block";
        phoneSubmit.textContent = "Verify Code";
        showSuccess(phoneSuccess, "Verification code sent!");
      } else {
        // Second step: Verify code
        await confirmationResult.confirm(verificationCode);
        showSuccess(phoneSuccess, "Phone verified successfully!");
        setTimeout(closeAuthModal, 1500);
      }
    } catch (error) {
      console.error("Phone auth error:", error);
      showError(phoneError, error.message);
    }
  });

  // Google Authentication
  googleSignIn.addEventListener("click", async () => {
    try {
      await signInWithPopup(auth, provider);
      closeAuthModal();
    } catch (error) {
      console.error("Google auth error:", error);
      showError(emailError, error.message);
    }
  });

  // Anonymous Authentication
  anonymousSignIn.addEventListener("click", async () => {
    try {
      await signInAnonymously(auth);
      closeAuthModal();
    } catch (error) {
      console.error("Anonymous auth error:", error);
      showError(emailError, error.message);
    }
  });

  // Sign Out
  signOutButton.addEventListener("click", async () => {
    try {
      await signOut(auth);
      closeAccountModal();
    } catch (error) {
      console.error("Sign out error:", error);
    }
  });

  // Manage Account (external link)
  manageAccount.addEventListener("click", () => {
    window.open("taisen-login/index.html", "_blank");
  });

  // View Analytics
  viewAnalytics.addEventListener("click", () => {
    window.open('analytics-dashboard.html', '_blank');
    closeAccountModal();
  });

  // Update User Button
  function updateButton(user) {
    if (user) {
      // User is signed in - show user's name or "User"
      const name = user.displayName || "User";
      userButton.textContent = name;
      userButton.style.display = "block";
      userButton.onclick = openAccountModal;
    } else {
      // User is signed out - show "Sign In" button
      userButton.textContent = "Sign In";
      userButton.style.display = "block";
      userButton.onclick = openAuthModal;
    }
  }

  // Event Listeners
  authClose.addEventListener("click", closeAuthModal);
  accountClose.addEventListener("click", closeAccountModal);
  
  // Close modals when clicking outside
  authModal.addEventListener("click", (e) => {
    if (e.target === authModal) {
      closeAuthModal();
    }
  });

  accountModal.addEventListener("click", (e) => {
    if (e.target === accountModal) {
      closeAccountModal();
    }
  });

  // Initialize auth state listener
  onAuthStateChanged(auth, (user) => {
    updateButton(user);
  });

  // Log search function
  async function logSearch(query) {
    const user = auth.currentUser;
    if (!user) return;
    try {
      const userRef = doc(db, "users", user.uid);
      await setDoc(userRef, { 
        lastSearch: query, 
        timestamp: new Date(),
        email: user.email,
        displayName: user.displayName 
      }, { merge: true });
      console.log("Search logged:", query);
    } catch (err) {
      console.error("Error logging search:", err);
    }
  }

  // Override search execution to log searches
  const interval = setInterval(() => {
    if (window.google && google.search && google.search.cse) {
      const searchBox = google.search.cse.element.getElement("gcse-searchbox-only");
      if (searchBox && searchBox.execute) {
        clearInterval(interval);
        const originalExecute = searchBox.execute.bind(searchBox);
        searchBox.execute = function(query) {
          if (query && query.trim() !== "") logSearch(query);
          originalExecute(query);
        };
      }
    }
  }, 100);
</script>

<!-- Hamburger functionality from index.html -->
<script>
  const hamburger = document.getElementById('hamburger');
  hamburger.addEventListener('click', () => {
    hamburger.classList.toggle('active');
    window.location.href = 'settings.html'; // Opens settings page
  });
</script>

<!-- Anti-bypass protection -->
<script type="module">
  import { protectPage } from './antiBypass.js';
  protectPage(); // will redirect if bypass attempt is detected
</script>

<style>
@keyframes bounce {
    0%, 80%, 100% { 
        transform: scale(0.8); 
        opacity: 0.5; 
    }
    40% { 
        transform: scale(1); 
        opacity: 1; 
    }
}
</style>
<script>
  // Create Taisen-styled container for refinement tabs with uniform sizing
function createTaisenRefinementContainer() {
    const interval = setInterval(() => {
        const refinementsArea = document.querySelector('.gsc-refinementsArea');
        const header = document.querySelector('header');
        const main = document.querySelector('.results-container');
        
        if (refinementsArea && header && main) {
            clearInterval(interval);
            
            // Remove existing Taisen container if it exists
            const existingContainer = document.querySelector('.taisen-refinements-container');
            if (existingContainer) {
                existingContainer.remove();
            }
            
            // Create Taisen-styled container
            const taisenContainer = document.createElement('div');
            taisenContainer.className = 'taisen-refinements-container';
            
            // Create inner container for content
            const innerContainer = document.createElement('div');
            innerContainer.className = 'taisen-refinements-inner';
            
            // Find all refinement elements
            const refinementHeaders = refinementsArea.querySelectorAll('.gsc-refinementHeader');
            
            if (refinementHeaders.length > 0) {
                // Create Taisen-styled chips for each refinement
                refinementHeaders.forEach((refinement, index) => {
                    const chip = document.createElement('button');
                    chip.className = 'taisen-refinement-chip';
                    
                    // Copy text content
                    const textElement = refinement.querySelector('.gsc-refinementh');
                    chip.textContent = textElement ? textElement.textContent : refinement.textContent;
                    
                    // Copy selected state
                    if (refinement.classList.contains('gsc-selected')) {
                        chip.classList.add('selected');
                    }
                    
                    // Copy click functionality
                    chip.addEventListener('click', () => {
                        refinement.click();
                    });
                    
                    // Add to container
                    innerContainer.appendChild(chip);
                });
                
                // Observe for changes in original refinements to sync states
                const observer = new MutationObserver(() => {
                    syncRefinementStates(refinementHeaders, innerContainer);
                });
                
                observer.observe(refinementsArea, {
                    attributes: true,
                    attributeFilter: ['class'],
                    subtree: true
                });
                
                // Add container to DOM
                taisenContainer.appendChild(innerContainer);
                main.parentNode.insertBefore(taisenContainer, main);
                
                console.log('Taisen refinement container created with', refinementHeaders.length, 'uniform chips');
            }
            
            // Handle responsive layout
            handleRefinementLayout();
        }
    }, 100);
}

// Sync selected states between original and Taisen chips
function syncRefinementStates(originalRefinements, taisenContainer) {
    const taisenChips = taisenContainer.querySelectorAll('.taisen-refinement-chip');
    
    originalRefinements.forEach((original, index) => {
        const taisenChip = taisenChips[index];
        if (taisenChip) {
            if (original.classList.contains('gsc-selected')) {
                taisenChip.classList.add('selected');
            } else {
                taisenChip.classList.remove('selected');
            }
        }
    });
}

// Handle responsive layout
function handleRefinementLayout() {
    const innerContainer = document.querySelector('.taisen-refinements-inner');
    
    if (!innerContainer) return;
    
    if (window.innerWidth <= 768) {
        innerContainer.style.overflowX = 'auto';
        innerContainer.style.flexWrap = 'nowrap';
        innerContainer.style.whiteSpace = 'nowrap';
    } else {
        innerContainer.style.overflowX = 'visible';
        innerContainer.style.flexWrap = 'wrap';
        innerContainer.style.whiteSpace = 'normal';
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', createTaisenRefinementContainer);
window.addEventListener('load', createTaisenRefinementContainer);

// Handle window resize
window.addEventListener('resize', handleRefinementLayout);

// Observe for dynamic content changes
const observer = new MutationObserver(function(mutations) {
    let shouldUpdate = false;
    
    mutations.forEach(function(mutation) {
        if (mutation.addedNodes.length) {
            Array.from(mutation.addedNodes).forEach(node => {
                if (node.nodeType === 1) {
                    if (node.classList?.contains('gsc-refinementsArea') || 
                        node.querySelector?.('.gsc-refinementsArea')) {
                        shouldUpdate = true;
                    }
                }
            });
        }
    });
    
    if (shouldUpdate) {
        setTimeout(createTaisenRefinementContainer, 500);
    }
});

observer.observe(document.body, {
    childList: true,
    subtree: true
});

// Also observe the GCSE results area specifically
const gcseObserver = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.target.classList?.contains('gcse-searchresults-only')) {
            setTimeout(createTaisenRefinementContainer, 300);
        }
    });
});

const gcseElement = document.querySelector('.gcse-searchresults-only');
if (gcseElement) {
    gcseObserver.observe(gcseElement, {
        childList: true,
        subtree: true
    });
}
</script>
</body>
</html>