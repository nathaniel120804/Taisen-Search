<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Search Results - Taisen</title>
<link rel="icon" type="image/png" href="original.png">
<link rel="stylesheet" href="style.css"
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script async src="https://cse.google.com/cse.js?cx=178f66b21f928448b"></script>

<style>
/* Modernized base styles from index.html */
:root {
  --primary: #0077ff;
  --primary-dark: #0056cc;
  --secondary: #6c757d;
  --success: #34a853;
  --danger: #d93025;
  --warning: #ffc107;
  --info: #17a2b8;
  --light: #f8f9fa;
  --dark: #343a40;
  --white: #ffffff;
  --gray-100: #f8f9fa;
  --gray-200: #e9ecef;
  --gray-300: #dee2e6;
  --gray-400: #ced4da;
  --gray-500: #adb5bd;
  --gray-600: #6c757d;
  --gray-700: #495057;
  --gray-800: #343a40;
  --gray-900: #212529;
  --gradient-primary: linear-gradient(135deg, #0077ff 0%, #0056cc 100%);
  --gradient-secondary: linear-gradient(135deg, #6c757d 0%, #495057 100%);
  --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
  --shadow-xl: 0 20px 25px rgba(0,0,0,0.15);
  --border-radius: 8px;
  --border-radius-lg: 12px;
  --transition: all 0.3s ease;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  color: var(--gray-800);
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Header - Applied index.html header styling */
header {
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow-sm);
  position: relative;
  z-index: 1000;
}

.hamburger {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  width: 24px;
  height: 18px;
  cursor: pointer;
  transition: var(--transition);
}

.hamburger div {
  height: 2px;
  background: var(--gray-700);
  border-radius: 2px;
  transition: var(--transition);
}

.hamburger:hover div {
  background: var(--primary);
}

.hamburger.active div:nth-child(1) {
  transform: rotate(45deg) translate(5px, 5px);
}

.hamburger.active div:nth-child(2) {
  opacity: 0;
}

.hamburger.active div:nth-child(3) {
  transform: rotate(-45deg) translate(7px, -6px);
}

/* Results-specific styling - KEEPING ALL ORIGINAL FUNCTIONALITY */
.results-header-inner {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
  display: flex;
  align-items: center;
  gap: 1.5rem;
  width: 100%;
}

.logo-link {
  display: flex;
  align-items: center;
}

.results-name {
  font-size: 1.75rem;
  font-weight: 700;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.searchbar-container {
  flex: 1;
  max-width: 600px;
}

.gsc-control-cse {
  padding: 0 !important;
  border: none !important;
  background: transparent !important;
}

.gsc-search-box {
  margin-bottom: 0 !important;
}

.gsc-input-box {
  border: 1px solid var(--gray-300) !important;
  border-radius: 24px !important;
  height: 44px !important;
  padding: 0 12px !important;
  background-color: var(--white) !important;
  transition: var(--transition);
  margin-right: 20px;
}

.gsc-input-box:hover, .gsc-input-box:focus-within {
  border-color: var(--primary) !important;
  box-shadow: 0 0 0 3px rgba(0, 119, 255, 0.1) !important;
}

.gsc-input {
  padding: 0 !important;
  font-size: 16px !important;
  color: var(--gray-800) !important;
  background-color: transparent !important;
}

.gsc-search-button {
  background-color: var(--primary) !important;
  border-color: var(--primary) !important;
  border-radius: 30px !important;
  padding: 8px 16px !important;
}
.gsc-webResult .gsc-result {
  padding: 20px !important;
  margin-bottom: 20px !important;
  background: var(--white) !important;
  border-radius: var(--border-radius-lg) !important;
  box-shadow: var(--shadow-md) !important;
  border: none !important;
  color: var(--gray-800) !important;
}
.gsc-webResult .gsc-result .gs-title {
  font-size: 18px !important;
  font-weight: bold !important;
  color: var(--primary) !important;
}
/* Main Content - KEEPING ORIGINAL STRUCTURE */
.results-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 1.5rem 1rem;
  flex: 1;
  display: flex;
  gap: 2rem;
}

/* Controls Panel - Applied modern styling */
.controls-panel {
  flex: 0 0 250px;
  background: var(--white);
  border-radius: var(--border-radius-lg);
  padding: 1.5rem;
  height: fit-content;
  box-shadow: var(--shadow-md);
  transition: var(--transition);
}

.control-group {
  margin-bottom: 1.5rem;
}

.control-group h3 {
  font-size: 1.1rem;
  margin-bottom: 0.75rem;
  color: var(--gray-700);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* Toggle Styles - Modernized */
.toggle-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.toggle-label {
  font-weight: 500;
  color: var(--gray-700);
}

.switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
}

.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 24px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: var(--primary);
}

input:checked + .slider:before {
  transform: translateX(20px);
}

/* Filter Styles - Modernized */
.filter-container {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.filter-label {
  font-weight: 500;
  color: var(--gray-700);
}

select {
  padding: 0.5rem 0.75rem;
  border: 1px solid var(--gray-300);
  border-radius: var(--border-radius);
  background-color: var(--white);
  font-size: 0.9rem;
  color: var(--gray-800);
  cursor: pointer;
  transition: var(--transition);
}

select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 119, 255, 0.1);
}

/* Results Section - Modernized */
.results-section {
  flex: 1;
}

.results-header-info {
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--gray-300);
}

.results-count {
  font-size: 0.9rem;
  color: var(--gray-600);
}

.query-term {
  font-weight: 600;
  color: var(--primary);
}

/* Internal Results - Modernized */
.internal-results {
  margin-bottom: 2rem;
}

.section-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: var(--gray-700);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.result-card {
  background: var(--white);
  border-radius: var(--border-radius);
  padding: 1.25rem;
  margin-bottom: 1rem;
  box-shadow: var(--shadow-sm);
  border-left: 4px solid var(--primary);
  transition: var(--transition);
}

.result-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.result-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--primary);
}

.result-snippet {
  color: var(--gray-700);
  margin-bottom: 0.75rem;
  line-height: 1.5;
}

.result-meta {
  display: flex;
  gap: 1rem;
  font-size: 0.85rem;
  color: var(--gray-600);
}

.result-link {
  display: inline-block;
  margin-top: 0.5rem;
  font-weight: 500;
  color: var(--primary);
  transition: var(--transition);
}

.result-link:hover {
  color: var(--primary-dark);
  transform: translateX(3px);
}

.no-results {
  text-align: center;
  padding: 2rem;
  color: var(--gray-600);
  background: var(--gray-100);
  border-radius: var(--border-radius);
}

/* Google CSE Results - Modernized */
.gcse-searchresults-only {
  margin-top: 2rem;
}

.gsc-results {
  width: 100% !important;
}

.gsc-webResult .gs-title {
  font-size: 1.1rem !important;
  line-height: 1.4 !important;
  color: var(--primary) !important;
}

.gsc-webResult .gs-snippet {
  font-size: 0.95rem !important;
  line-height: 1.5 !important;
  color: var(--gray-700) !important;
}

.gsc-result {
  background-color: var(--white) !important;
  border-color: var(--gray-300) !important;
}

.gsc-table-result {
  color: var(--gray-800) !important;
}

/* User Button from index.html */
#userButton {
  padding: 10px 20px;
  background: var(--gradient-primary);
  color: var(--white);
  border: none;
  border-radius: 50px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
  box-shadow: var(--shadow-md);
  transition: var(--transition);
}

#userButton:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

/* Footer from index.html */
footer {
  padding: 20px;
  text-align: center;
  background: rgba(255, 255, 255, 0.8);
  margin-top: auto;
}

.footer-links a {
      color: var(--gray-500);
      text-decoration: none;
      margin: 0 8px;
      transition: var(--transition);
    }

.footer-links a:hover {
  color: var(--primary);
}

/* Knowledge Panel Styles */
.knowledge-panel {
  flex: 0 0 350px;
  background: var(--white);
  border-radius: var(--border-radius-lg);
  box-shadow: var(--shadow-md);
  overflow: hidden;
  position: sticky;
  top: 20px;
  max-height: 80vh;
  overflow-y: auto;
  display: none;
}

.knowledge-header {
  background: var(--gradient-primary);
  color: white;
  padding: 1.5rem;
}

.knowledge-title {
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.knowledge-subtitle {
  opacity: 0.9;
  font-size: 0.9rem;
}

.knowledge-body {
  padding: 1.5rem;
}

.knowledge-section {
  margin-bottom: 1.5rem;
}

.section-title {
  font-size: 1.1rem;
  margin-bottom: 0.75rem;
  color: var(--gray-700);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.knowledge-description {
  color: var(--gray-600);
  line-height: 1.5;
  margin-bottom: 1rem;
}

.fact-grid {
  display: grid;
  gap: 0.75rem;
}

.fact-item {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--gray-200);
}

.fact-label {
  font-weight: 500;
  color: var(--gray-700);
  font-size: 0.9rem;
}

.fact-value {
  color: var(--gray-600);
  text-align: right;
  font-size: 0.9rem;
  max-width: 200px;
}

.quick-actions {
  background: var(--gray-100);
  padding: 1rem;
  border-radius: var(--border-radius);
  margin-top: 1.5rem;
}

.action-buttons {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.action-button {
  padding: 0.5rem 1rem;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: var(--border-radius);
  cursor: pointer;
  font-size: 0.8rem;
  transition: var(--transition);
}

.action-button:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.action-button.secondary {
  background: var(--gray-600);
}

.action-button.secondary:hover {
  background: var(--gray-700);
}

/* NEW STYLES FOR AI RESPONSE TRUNCATION */
.ai-response {
  position: relative;
  overflow: hidden;
}

.ai-response.truncated {
  max-height: 200px;
}

.ai-response.truncated::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: linear-gradient(transparent, var(--white));
  pointer-events: none;
}

.read-more-btn {
  background: transparent;
  border: none;
  color: var(--primary);
  cursor: pointer;
  font-weight: 500;
  margin-top: 10px;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: var(--transition);
  padding: 8px 0;
}

.read-more-btn:hover {
  color: var(--primary-dark);
}

.read-more-btn i {
  transition: var(--transition);
}

.read-more-btn.expanded i {
  transform: rotate(180deg);
}

.account-button.analytics {
      background: var(--info);
      color: white;
    }

    .account-button.analytics:hover {
      background: #138496;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .gsc-adBlock, .gcsc-find-more-on-google { display: none !important; }

/* Loading indicator */
.loading-indicator {
  display: flex;
  justify-content: center;
  gap: 4px;
  margin: 20px 0;
}

.dot {
  width: 8px;
  height: 8px;
  background: var(--primary);
  border-radius: 50%;
  animation: bounce 1.4s infinite ease-in-out;
}

.dot:nth-child(2) {
  animation-delay: 0.2s;
}

.dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes bounce {
  0%, 80%, 100% { 
    transform: scale(0.8); 
    opacity: 0.5; 
  }
  40% { 
    transform: scale(1); 
    opacity: 1; 
  }
}

/* Knowledge Panel Scrollbar */
.knowledge-panel::-webkit-scrollbar {
  width: 6px;
}

.knowledge-panel::-webkit-scrollbar-track {
  background: var(--gray-100);
  border-radius: 3px;
}

.knowledge-panel::-webkit-scrollbar-thumb {
  background: var(--gray-400);
  border-radius: 3px;
}

.knowledge-panel::-webkit-scrollbar-thumb:hover {
  background: var(--gray-500);
}

/* Responsive Design */
@media (max-width: 1024px) {
  .results-container {
    flex-direction: column;
  }
  
  .knowledge-panel {
    position: static;
    max-height: none;
    flex: none;
    width: 100%;
  }
}

@media (max-width: 768px) {
  .results-container {
    flex-direction: column;
    gap: 1.5rem;
  }
  
  .controls-panel {
    flex: none;
  }
  
  .results-header-inner {
    flex-direction: column;
    gap: 1rem;
  }
  
  .searchbar-container {
    width: 100%;
  }
  
  header {
    flex-direction: column;
    gap: 1rem;
    padding: 10px;
  }
}

/* Dark mode support from index.html */
@media (prefers-color-scheme: dark) {
  :root {
    --light: #1a1a1a;
    --dark: #f8f9fa;
    --white: #2d2d2d;
    --gray-100: #1a1a1a;
    --gray-200: #2d2d2d;
    --gray-300: #404040;
    --gray-400: #595959;
    --gray-500: #737373;
    --gray-600: #8c8c8c;
    --gray-700: #a6a6a6;
    --gray-800: #bfbfbf;
    --gray-900: #d9d9d9;
  }

  body {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    color: var(--gray-800);
  }

  header, footer {
    background: rgba(45, 45, 45, 0.95);
  }

  .results-name {
    background: linear-gradient(135deg, #4dabf7 0%, #339af0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
}
/* Taisen-Style Pagination - Synced with Design Guidelines */
.gsc-cursor-box {
  text-align: center;
  margin-top: 20px;
  padding: 20px;
  background: var(--white);
  border-radius: var(--border-radius-lg);
  box-shadow: var(--shadow-sm);
  transition: var(--transition);
  position: relative;
}

.gsc-cursor-box:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-1px);
}

/* Taisen Brand Header - Using Design System Colors */
.gsc-cursor-box::before {
  content: "Taaaaaaaaaisen";
  font-size: 1.75rem;
  font-weight: 700;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  display: block;
  margin-bottom: 15px;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  letter-spacing: -0.5px;
}

/* Page Numbers - Using Design System */
.gsc-cursor-page {
  color: var(--primary);
  font-size: 0.9rem;
  font-weight: 500;
  padding: 8px 12px;
  margin: 0 2px;
  text-decoration: none;
  background: var(--white);
  border-radius: var(--border-radius);
  border: 1px solid var(--gray-300);
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
}

/* Active Page - Using Primary Gradient */
.gsc-cursor-current-page {
  background: var(--gradient-primary);
  color: var(--white) !important;
  font-weight: 600;
  border: 1px solid var(--primary);
  box-shadow: var(--shadow-sm);
  transform: translateY(-1px);
}

/* Next Button - Consistent Styling */
.gsc-cursor-next-page {
  color: var(--primary);
  margin-left: 12px;
  text-decoration: none;
  font-weight: 500;
  padding: 8px 16px;
  background: var(--white);
  border-radius: var(--border-radius);
  border: 1px solid var(--gray-300);
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

/* Hover Effects - Consistent with Design System */
.gsc-cursor-page:hover,
.gsc-cursor-next-page:hover {
  color: var(--primary-dark);
  background: rgba(0, 119, 255, 0.05);
  border-color: var(--primary);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
  text-decoration: none;
}

/* Focus States for Accessibility */
.gsc-cursor-page:focus,
.gsc-cursor-next-page:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 119, 255, 0.1);
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .gsc-cursor-box {
    padding: 15px;
  }
  
  .gsc-cursor-box::before {
    font-size: 1.5rem;
    margin-bottom: 12px;
  }
  
  .gsc-cursor-page,
  .gsc-cursor-next-page {
    padding: 6px 10px;
    font-size: 0.85rem;
    margin: 0 1px;
    min-width: 36px;
  }
}

/* Dark Mode Support */
@media (prefers-color-scheme: dark) {
  .gsc-cursor-box {
    background: var(--white);
    border-color: var(--gray-300);
  }
  
  .gsc-cursor-page,
  .gsc-cursor-next-page {
    background: var(--white);
    border-color: var(--gray-300);
    color: var(--primary);
  }
  
  .gsc-cursor-page:hover,
  .gsc-cursor-next-page:hover {
    background: rgba(0, 119, 255, 0.1);
    border-color: var(--primary);
  }
  
  .gsc-cursor-current-page {
    background: var(--gradient-primary);
    color: var(--white) !important;
  }
}
</style>
</head>
<body>

<!-- Header with index.html design -->
<header>
  
  <!-- Results header content maintained -->
  <div class="results-header-inner">
    <a href="index.html" class="logo-link">
      <h1 class="results-name">Taisen</h1>
    </a>
    <div class="searchbar-container">
      <div class="gcse-searchbox-only" data-resultsUrl="results.html" data-newWindow="false"></div>
    </div>
  </div>
  
  <!-- User Button -->
  <button id="userButton">Sign In</button>
</header>

<!-- Main content UNCHANGED -->
<main class="results-container">
  <!-- Controls Panel -->
  <aside class="controls-panel">
    <div class="control-group">
      <h3>Search Controls</h3>
      
      <!-- Labs toggle -->
      <div class="toggle-container">
        <span class="toggle-label">Show Labs</span>
        <label class="switch">
          <input type="checkbox" id="labsToggle" checked>
          <span class="slider"></span>
        </label>
      </div>

      <!-- Filter dropdown -->
      <div class="filter-container">
        <label for="filter" class="filter-label">Filter by Category</label>
        <select id="filter">
          <option value="all">All Categories</option>
          <option value="STEM">STEM</option>
          <option value="Psychology">Psychology</option>
          <option value="Experiments / Labs">Experiments / Labs</option>
        </select>
      </div>
    </div>
    
    <div class="control-group">
      <h3>Search Tips</h3>
      <p style="font-size: 0.9rem; color: var(--gray-600);">
        Use specific keywords for better results. Try filtering by category to narrow down your search.
      </p>
    </div>
  </aside>

  <!-- Results Section -->
  <section class="results-section">
    <div class="results-header-info">
      <p class="results-count">Search results for: <span class="query-term" id="queryTerm">Loading...</span></p>
    </div>

    <!-- AI Results -->
    <div id="taisen-ai-results"></div>

    <!-- Internal results -->
    <div class="internal-results">
      <h2 class="section-title">Taisen Labs Results</h2>
      <div id="results-internal"></div>
    </div>

    <!-- Google CSE Results -->
    <div class="gcse-searchresults-only"></div>
  </section>

  <!-- Knowledge Panel -->
  <aside class="knowledge-panel" id="knowledgePanel">
    <!-- Knowledge panel will be populated by JavaScript -->
  </aside>
</main>

<!-- Footer from index.html -->
<footer class="Footer">
    <div class="footer-section">
      <nav class="footer-links">
        <a href="about.html">About</a>
        <a href="advertising.html">Advertising</a>
        <a href="help center.html">Help Center</a>
        <a href="labs.html">Labs</a>
        <a href="security.html">Security</a>
        <a href="TaisenSearch_Documentation.html">Documentation</a>
      </nav>
    </div>
  </footer>

<script>
// Wikipedia Knowledge Panel Integration
class TAISEN_KnowledgePanel {
    constructor() {
        this.panel = document.getElementById('knowledgePanel');
        this.isProcessing = false;
    }

    async fetchData(query) {
        if (this.isProcessing) return;
        
        this.isProcessing = true;
        this.showLoading();

        try {
            // Search Wikipedia for the page
            const searchData = await this.searchWikipedia(query);
            if (!searchData || !searchData.query || !searchData.query.search.length) {
                this.showNoResults();
                return;
            }

            const pageTitle = searchData.query.search[0].title;
            
            // Get page content and extract
            const pageData = await this.getPageData(pageTitle);
            
            // Get Wikidata structured data
            const wikidataInfo = await this.getWikidataInfo(pageTitle);
            
            // Display the knowledge panel
            this.displayKnowledgePanel(pageTitle, pageData, wikidataInfo);
            
        } catch (error) {
            console.error('Knowledge Panel Error:', error);
            this.showError();
        } finally {
            this.isProcessing = false;
        }
    }

    async searchWikipedia(query) {
        const url = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*`;
        const response = await fetch(url);
        return await response.json();
    }

    async getPageData(pageTitle) {
        const url = `https://en.wikipedia.org/w/api.php?action=query&prop=extracts|pageimages|info&exintro=true&explaintext=true&pithumbsize=400&titles=${encodeURIComponent(pageTitle)}&format=json&origin=*`;
        const response = await fetch(url);
        const data = await response.json();
        
        const pageId = Object.keys(data.query.pages)[0];
        return data.query.pages[pageId];
    }

    async getWikidataInfo(pageTitle) {
        try {
            // Get Wikidata ID
            const propsUrl = `https://en.wikipedia.org/w/api.php?action=query&prop=pageprops&titles=${encodeURIComponent(pageTitle)}&format=json&origin=*`;
            const propsResponse = await fetch(propsUrl);
            const propsData = await propsResponse.json();
            
            const pageId = Object.keys(propsData.query.pages)[0];
            const wikidataId = propsData.query.pages[pageId].pageprops?.wikibase_item;
            
            if (!wikidataId) return null;

            // Get Wikidata entity data
            const wikidataUrl = `https://www.wikidata.org/wiki/Special:EntityData/${wikidataId}.json`;
            const wdResponse = await fetch(wikidataUrl);
            const wdData = await wdResponse.json();
            
            return wdData.entities[wikidataId];
        } catch (error) {
            console.error('Wikidata fetch error:', error);
            return null;
        }
    }

    showLoading() {
        this.panel.innerHTML = `
            <div class="knowledge-header">
                <div class="knowledge-title">Loading Knowledge Panel</div>
                <div class="knowledge-subtitle">Fetching information from Wikipedia</div>
            </div>
            <div class="knowledge-body">
                <div class="loading-indicator">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        `;
        this.panel.style.display = 'block';
    }

    showNoResults() {
        this.panel.innerHTML = `
            <div class="knowledge-header">
                <div class="knowledge-title">No Knowledge Panel Available</div>
                <div class="knowledge-subtitle">Try a different search term</div>
            </div>
            <div class="knowledge-body">
                <p>We couldn't find structured information for this search term in Wikipedia.</p>
            </div>
        `;
        this.panel.style.display = 'block';
    }

    showError() {
        this.panel.innerHTML = `
            <div class="knowledge-header">
                <div class="knowledge-title">Error Loading Knowledge Panel</div>
                <div class="knowledge-subtitle">Please try again later</div>
            </div>
            <div class="knowledge-body">
                <p>There was an error fetching information from Wikipedia. Please check your connection and try again.</p>
            </div>
        `;
        this.panel.style.display = 'block';
    }

    displayKnowledgePanel(pageTitle, pageData, wikidataInfo) {
        const extract = pageData.extract ? pageData.extract.substring(0, 300) + '...' : 'No description available.';
        const thumbnail = pageData.thumbnail ? pageData.thumbnail.source : null;
        
        // Extract basic info from Wikidata if available
        let structuredInfo = this.extractStructuredInfo(wikidataInfo);

        this.panel.innerHTML = `
            <div class="knowledge-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    ${thumbnail ? `<img src="${thumbnail}" alt="${pageTitle}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;">` : ''}
                    <div>
                        <div class="knowledge-title">${pageTitle}</div>
                        <div class="knowledge-subtitle">Wikipedia</div>
                    </div>
                </div>
            </div>

            <div class="knowledge-body">
                <div class="knowledge-section">
                    <div class="section-title">
                        <i class="fas fa-book"></i> Description
                    </div>
                    <p class="knowledge-description">${extract}</p>
                    <a href="https://en.wikipedia.org/wiki/${encodeURIComponent(pageTitle)}" target="_blank" style="color: var(--primary); text-decoration: none; font-size: 14px; font-weight: 500;">Read more on Wikipedia â†’</a>
                </div>

                ${structuredInfo ? `
                <div class="knowledge-section">
                    <div class="section-title">
                        <i class="fas fa-info-circle"></i> Key Facts
                    </div>
                    <div class="fact-grid">
                        ${structuredInfo.map(fact => `
                            <div class="fact-item">
                                <span class="fact-label">${fact.label}:</span>
                                <span class="fact-value">${fact.value}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="quick-actions">
                    <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--gray-700);">Quick Actions</h4>
                    <div class="action-buttons">
                        <button class="action-button" onclick="window.open('https://en.wikipedia.org/wiki/${encodeURIComponent(pageTitle)}', '_blank')">
                            Open Wikipedia
                        </button>
                        <button class="action-button secondary" onclick="window.open('https://www.google.com/search?q=${encodeURIComponent(pageTitle)}', '_blank')">
                            Google Search
                        </button>
                    </div>
                </div>
            </div>
        `;
        this.panel.style.display = 'block';
    }

    extractStructuredInfo(wikidataInfo) {
        if (!wikidataInfo || !wikidataInfo.claims) return null;

        const facts = [];
        
        // Extract common properties
        const propertyMap = {
            'P571': 'Founded',
            'P159': 'Headquarters',
            'P112': 'Founders',
            'P169': 'CEO',
            'P2139': 'Revenue',
            'P1128': 'Employees',
            'P17': 'Country',
            'P571': 'Inception',
        };

        for (const [property, label] of Object.entries(propertyMap)) {
            if (wikidataInfo.claims[property]) {
                const claim = wikidataInfo.claims[property][0];
                if (claim.mainsnak && claim.mainsnak.datavalue) {
                    let value = this.formatWikidataValue(claim.mainsnak.datavalue);
                    if (value) {
                        facts.push({ label, value });
                    }
                }
            }
        }

        return facts.length > 0 ? facts : null;
    }

    formatWikidataValue(datavalue) {
        try {
            if (datavalue.type === 'time') {
                return datavalue.value.time.substring(1, 11); // Extract date from timestamp
            } else if (datavalue.type === 'string') {
                return datavalue.value;
            } else if (datavalue.type === 'wikibase-entityid') {
                return 'Entity'; // For entities, you could fetch the label, but keeping it simple
            }
        } catch (error) {
            console.error('Error formatting Wikidata value:', error);
        }
        return null;
    }
}

// AI GPT Search Integration for Results Page
class TAISEN_AIResults {
    constructor() {
        this.API_KEY = '4344c369928a4a26997e233f39cce26d';
        this.API_URL = 'https://api.aimlapi.com/v1/chat/completions';
        this.MODEL = 'google/gemma-3-12b-it';
        this.aiResultsContainer = null;
        this.isProcessing = false;
        this.MAX_VISIBLE_LENGTH = 800;
    }

    init() {
        this.createAIContainer();
        this.processCurrentSearch();
        this.overrideResultsSearch();
    }

    createAIContainer() {
        this.aiResultsContainer = document.getElementById('taisen-ai-results');
    }

    processCurrentSearch() {
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q');
        if (query && query.trim() !== "") {
            setTimeout(() => {
                this.showAIResults(query);
            }, 1000);
        }
    }

    overrideResultsSearch() {
        const interval = setInterval(() => {
            if (window.google && google.search && google.search.cse) {
                const searchBox = google.search.cse.element.getElement("gcse-searchbox-only");
                if (searchBox && searchBox.execute) {
                    clearInterval(interval);
                    
                    const originalExecute = searchBox.execute.bind(searchBox);
                    searchBox.execute = (query) => {
                        if (query && query.trim() !== "") {
                            setTimeout(() => {
                                this.showAIResults(query);
                            }, 1000);
                        }
                        originalExecute(query);
                    };
                }
            }
        }, 100);
    }

    async showAIResults(query) {
        if (this.isProcessing) return;
        
        this.isProcessing = true;
        this.showLoadingState(query);

        try {
            const aiResponse = await this.fetchAIResponse(query);
            this.displayAIResults(query, aiResponse);
        } catch (error) {
            console.error('AI Search Error:', error);
            this.hideAIResults();
        } finally {
            this.isProcessing = false;
        }
    }

    showLoadingState(query) {
        this.aiResultsContainer.innerHTML = `
            <div class="result-card">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; color: var(--primary); font-weight: 600; font-size: 18px;">
                    <span>ðŸ¤– TAISEN AI</span>
                    <div style="display: flex; gap: 4px;">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
                <div style="color: var(--gray-800); margin-bottom: 10px; font-weight: 500;">
                    Generating AI overview for: "${query}"
                </div>
            </div>
        `;
    }

    async fetchAIResponse(query) {
        const requestBody = {
            model: this.MODEL,
            messages: [
                {
                    role: "user",
                    content: `Provide a comprehensive, well-structured answer about: ${query}. Use clear paragraphs, bullet points with emojis, and keep it informative yet concise (under 400 words). Focus on key facts and insights.`
                }
            ],
            temperature: 0.2,
            top_p: 0.7,
            frequency_penalty: 1,
            max_tokens: 1536,
            top_k: 50
        };

        const response = await fetch(this.API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.API_KEY}`
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        return data.choices[0].message.content;
    }

    displayAIResults(query, aiResponse) {
        const needsTruncation = aiResponse.length > this.MAX_VISIBLE_LENGTH;
        const truncatedResponse = needsTruncation ? 
            aiResponse.substring(0, this.MAX_VISIBLE_LENGTH) + '...' : 
            aiResponse;
        
        this.aiResultsContainer.innerHTML = `
            <div class="result-card">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; color: var(--primary); font-weight: 600; font-size: 18px;">
                    <span>ðŸ¤–</span>
                    <span>TAISEN AI Overview</span>
                </div>
                
                <div style="color: var(--gray-800); margin-bottom: 15px; font-weight: 500; font-size: 16px; padding: 10px; background: var(--gray-100); border-radius: var(--border-radius);">
                    ${query}
                </div>
                
                <div class="ai-response ${needsTruncation ? 'truncated' : ''}" style="color: var(--gray-700); line-height: 1.6; font-size: 15px; margin-bottom: 15px; white-space: pre-wrap; word-wrap: break-word;">
                    ${needsTruncation ? truncatedResponse : aiResponse}
                </div>
                
                ${needsTruncation ? `
                <button class="read-more-btn" data-full-response="${aiResponse.replace(/"/g, '&quot;')}">
                    <span>Read more</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                ` : ''}
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--gray-300); color: var(--gray-600); font-size: 13px; display: flex; justify-content: space-between; align-items: center;">
                    <span>ðŸ¤– AI-powered search (Gemma-3-12b) â€¢ May include inaccuracies</span>
                </div>
            </div>
        `;

        if (needsTruncation) {
            const readMoreBtn = this.aiResultsContainer.querySelector('.read-more-btn');
            readMoreBtn.addEventListener('click', this.toggleReadMore.bind(this));
        }
    }

    toggleReadMore(event) {
        const button = event.target.closest('.read-more-btn');
        const aiResponseElement = button.previousElementSibling;
        const isExpanded = button.classList.contains('expanded');
        
        if (isExpanded) {
            const truncatedResponse = button.getAttribute('data-full-response').substring(0, this.MAX_VISIBLE_LENGTH) + '...';
            aiResponseElement.textContent = truncatedResponse;
            aiResponseElement.classList.add('truncated');
            button.innerHTML = '<span>Read more</span><i class="fas fa-chevron-down"></i>';
            button.classList.remove('expanded');
        } else {
            const fullResponse = button.getAttribute('data-full-response');
            aiResponseElement.textContent = fullResponse;
            aiResponseElement.classList.remove('truncated');
            button.innerHTML = '<span>Read less</span><i class="fas fa-chevron-up"></i>';
            button.classList.add('expanded');
        }
    }

    hideAIResults() {
        this.aiResultsContainer.innerHTML = '';
    }
}

// Original code below - with UI integration
let data = [];

// Helpers
function getQuery() {
    const query = new URLSearchParams(window.location.search).get('q') || '';
    document.getElementById('queryTerm').textContent = query;
    return query;
}

function getLabsPreference() {
    const saved = localStorage.getItem('showLabs');
    return saved === null ? true : saved === 'true';
}

function saveLabsPreference(value) {
    localStorage.setItem('showLabs', value);
}

// Load internal JSON data
async function loadData() {
    const response = await fetch('taisenData.json');
    data = await response.json();

    const labsToggle = document.getElementById('labsToggle');
    const filterEl = document.getElementById('filter');

    // Initialize toggle from localStorage
    labsToggle.checked = getLabsPreference();

    function updateResults() {
        const showLabs = labsToggle.checked;
        const label = filterEl.value;
        const query = getQuery();

        let resultsDiv = document.getElementById('results-internal');
        const sectionTitle = document.querySelector('.internal-results .section-title');

        if (!showLabs) {
            // If toggle OFF, hide internal results completely
            resultsDiv.innerHTML = '';
            sectionTitle.style.display = 'none';
            return;
        }
        
        sectionTitle.style.display = 'flex';

        // Filter results based on query & label
        const filtered = data.filter(item => {
            const matchesQuery = item.title.toLowerCase().includes(query.toLowerCase()) ||
                               item.snippet.toLowerCase().includes(query.toLowerCase());
            const matchesLabel = label === 'all' || item.label === label;
            return matchesQuery && matchesLabel;
        });

        // Display
        resultsDiv.innerHTML = '';
        if (!filtered.length) {
            resultsDiv.innerHTML = `
                <div class="no-results">
                    <p>No internal results found for your search.</p>
                    <p>Try adjusting your search terms or changing the category filter.</p>
                </div>
            `;
            return;
        }
        
        filtered.forEach(item => {
            const card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML = `
                <h3 class="result-title">${item.title}</h3>
                <p class="result-snippet">${item.snippet}</p>
                <div class="result-meta">
                    <span><strong>Type:</strong> ${item.type}</span>
                    <span><strong>Source:</strong> ${item.source}</span>
                </div>
                <a href="${item.link}" target="_blank" class="result-link">Visit Resource â†’</a>
            `;
            resultsDiv.appendChild(card);
        });
    }

    // Event listeners
    labsToggle.addEventListener('change', () => {
        saveLabsPreference(labsToggle.checked);
        updateResults();
    });
    
    filterEl.addEventListener('change', updateResults);

    // Initial display
    updateResults();
}

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', () => {
    // Initialize Knowledge Panel
    const knowledgePanel = new TAISEN_KnowledgePanel();
    
    // Initialize AI Results
    const aiResults = new TAISEN_AIResults();
    aiResults.init();
    
    // Load internal data
    loadData();
    
    // Override Google CSE to sync with knowledge panel
    const interval = setInterval(() => {
        if (window.google && google.search && google.search.cse) {
            const searchBox = google.search.cse.element.getElement("gcse-searchbox-only");
            if (searchBox && searchBox.execute) {
                clearInterval(interval);
                
                const originalExecute = searchBox.execute.bind(searchBox);
                searchBox.execute = (query) => {
                    if (query && query.trim() !== "") {
                        // Update query term
                        document.getElementById('queryTerm').textContent = query;
                        
                        // Fetch knowledge panel data
                        knowledgePanel.fetchData(query);
                    }
                    originalExecute(query);
                };
            }
        }
    }, 100);
});

// Set initial query from URL
window.addEventListener('load', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');
    if (query) {
        document.getElementById('queryTerm').textContent = query;
        
        // Initialize knowledge panel with initial query
        const knowledgePanel = new TAISEN_KnowledgePanel();
        knowledgePanel.fetchData(query);
    }
});
</script>
</body>
</html>