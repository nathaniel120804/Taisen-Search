<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Taisen</title>
  <link rel="icon" type="image/png" href="original.png">
  <link rel="stylesheet" href="style.css?v=20250901">
  <style>
    /* Additional styles for trivia feature */
    .trivia-container {
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: none;
    }
    
    .trivia-title {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 10px;
      color: #1a0dab;
    }
    
    .trivia-snippet {
      color: #4d5156;
      line-height: 1.4;
    }
    
    .trivia-link {
      display: block;
      margin-top: 10px;
      color: #1a0dab;
      text-decoration: none;
    }
    
    .trivia-link:hover {
      text-decoration: underline;
    }

    /* User sign-in button */
    #userButton {
      position: fixed;
      top: 50px;
      right: 20px;
      padding: 8px 12px;
      background: #0077ff;
      color: #fff;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      z-index: 1000;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div id="hamburger" class="hamburger">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <section class="header-section"></section>
  </header>

  <!-- Search Section -->
  <section class="search-section">
    <div><h1 class="site-title">Taisen</h1></div>
    <div class="search-container">
      <div class="gcse-searchbox-only" data-resultsUrl="captcha.html" data-newWindow="false"></div>
    </div>
  </section>

  <!-- Trivia Section -->
  <section id="triviaSection" class="trivia-container">
    <div class="trivia-title" id="triviaTitle"></div>
    <div class="trivia-snippet" id="triviaSnippet"></div>
    <a href="#" class="trivia-link" id="triviaLink" target="_blank">Read more</a>
  </section>

  <!-- Footer -->
  <footer>
    <section class="footer-section">
      <nav class="footer-links">
        <a href="about.html">About</a> ·
        <a href="advertising.html">Advertising</a> ·
        <a href="privacy.html">Privacy Policy</a> ·
        <a href="help center.html">Help Center</a> ·
        <a href="labs.html">Labs</a> ·
        <a href="TaisenSearch_Documentation.html">Docuementation</a>
      </nav>
    </section>
  </footer>

  <!-- Google Custom Search Script -->
  <script async src="https://cse.google.com/cse.js?cx=178f66b21f928448b"></script>

  <!-- Trivia + Search Logging -->
  <script>
    const SHEET_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbye72BaC5itl9lQNV8k8OrO_E4VjdFbqm3quUX6RnS8s9tOE_UbvVd8WBPLDhpgUp6W/exec";
    const CSE_CX = "178f66b21f928448b";
    const TRIVIA_TOPICS = [
      "interesting science facts",
      "historical events today",
      "amazing animal facts",
      "space exploration discoveries",
      "technology innovations",
      "world records facts",
      "cultural traditions around the world",
      "famous inventions history",
      "natural wonders of the world",
      "human body amazing facts"
    ];

    window.onload = () => {
      // Initialize CSE
      function initCSE() {
        if (typeof google === "undefined" || !google.search || !google.search.cse) {
          setTimeout(initCSE, 100);
          return;
        }
        const searchBox = google.search.cse.element.getElement("gcse-searchbox-only");
        if (!searchBox) return;
        const originalExecute = searchBox.execute;
        searchBox.execute = function(query) {
          console.log("User searched:", query);
          if (!query || query.trim() === "") {
            showRandomTrivia();
            return;
          }
          fetch(SHEET_WEB_APP_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query, timestamp: new Date() })
          }).then(res => res.json()).then(data => console.log("Logged:", data))
            .catch(err => console.error("Failed to log search:", err));
          originalExecute.call(searchBox, query);
        };
      }

      function showRandomTrivia() {
        const randomTopic = TRIVIA_TOPICS[Math.floor(Math.random() * TRIVIA_TOPICS.length)];
        fetch(`https://www.googleapis.com/customsearch/v1?key=AIzaSyCjAJ9y0oY7dI5qDZ_WbYqJ9Q8nQ9Q8nQ8&cx=${CSE_CX}&q=${encodeURIComponent(randomTopic)}&num=1`)
          .then(response => response.json())
          .then(data => {
            if (data.items && data.items.length > 0) {
              displayTrivia(data.items[0].title, data.items[0].snippet, data.items[0].link);
            } else {
              displayTrivia("Did you know?", "The world is full of interesting facts! Try searching for something specific to learn more.", "https://www.funtrivia.com/");
            }
          }).catch(() => {
            displayTrivia("Search Tip", "Enter a search term to explore the web.", "https://www.funtrivia.com/");
          });
      }

      function displayTrivia(title, snippet, link) {
        const triviaSection = document.getElementById('triviaSection');
        document.getElementById('triviaTitle').textContent = title;
        document.getElementById('triviaSnippet').textContent = snippet;
        const triviaLink = document.getElementById('triviaLink');
        triviaLink.href = link;
        triviaLink.textContent = "Learn more about this topic";
        triviaSection.style.display = 'block';
        setTimeout(() => triviaSection.style.display = 'none', 10000);
      }

      // Setup listeners
      function setupSearchListeners() {
        const checkElements = setInterval(() => {
          const searchButton = document.querySelector('.gsc-search-button');
          const searchInput = document.querySelector('.gsc-input input');
          if (searchButton && searchInput) {
            clearInterval(checkElements);
            searchButton.addEventListener('click', () => { if(searchInput.value.trim() === '') showRandomTrivia(); });
            searchInput.addEventListener('keypress', (event) => {
              if(event.key === 'Enter') setTimeout(() => { if(searchInput.value.trim() === '') { event.preventDefault(); showRandomTrivia(); } }, 10);
            });
          }
        }, 100);
      }

      initCSE();
      setupSearchListeners();
    };
  </script>

  <script>
    // Mobile redirect
    if (/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
      document.body.innerHTML = "<h1>Sorry, this website is not available on mobile devices.</h1>";
    }

    // Hamburger
    const hamburger = document.getElementById('hamburger');
    hamburger.addEventListener('click', () => {
      hamburger.classList.toggle('active');
      window.location.href = 'settings.html';
    });

    // Theme
    window.addEventListener('load', () => {
      if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
    });
  </script>

  <!-- Firebase Auth + Search Logging -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMy4SNOU3eAl4iSfbmHWTxae9pVcnJFmc",
      authDomain: "taisen-search-ad9eb.firebaseapp.com",
      projectId: "taisen-search-ad9eb",
      storageBucket: "taisen-search-ad9eb.appspot.com",
      messagingSenderId: "779736719927",
      appId: "1:779736719927:web:07ccea945f7549ad56d5b2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const userButton = document.getElementById("userButton");

    function updateButton(user) {
      if(user) {
        const name = user.displayName || "User";
        userButton.textContent = name + " (Sign Out)";
        userButton.onclick = async () => { await signOut(auth); };
      } else {
        userButton.textContent = "Sign In";
        userButton.onclick = async () => { await signInWithPopup(auth, provider); };
      }
    }

    onAuthStateChanged(auth, updateButton);

    async function logSearch(query) {
      const user = auth.currentUser;
      if(!user) return;
      try {
        const userRef = doc(db, "users", user.uid);
        await setDoc(userRef, { lastSearch: query, timestamp: new Date() }, { merge: true });
      } catch(err) { console.error("Error logging search:", err); }
    }

    const interval = setInterval(() => {
      const searchBox = google?.search?.cse?.element?.getElement("gcse-searchbox-only");
      if(searchBox && searchBox.execute) {
        clearInterval(interval);
        const originalExecute = searchBox.execute.bind(searchBox);
        searchBox.execute = function(query) { if(query && query.trim() !== "") logSearch(query); originalExecute(query); };
      }
    }, 100);
  </script>

</body>
</html>
