<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Debug Logs - Taisen</title>
<style>
:root {
  --primary: #0077ff; --primary-dark: #005fcc; --success: #28a745; --danger: #dc3545;
  --warning: #ffc107; --light: #f8f9fa; --dark: #343a40; --gray: #6c757d;
  --border-radius: 8px; --box-shadow: 0 4px 6px rgba(0,0,0,0.1); --transition: all 0.3s ease;
}
* {margin:0; padding:0; box-sizing:border-box;}
body {font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%); min-height:100vh; color: var(--dark); padding:20px;}
.container {max-width:1200px;margin:0 auto;}
.header {text-align:center; margin-bottom:30px; padding:20px; background:white; border-radius: var(--border-radius); box-shadow: var(--box-shadow);}
.header h1 {font-size:2.5rem; margin-bottom:10px; color: var(--primary); display:flex; align-items:center; justify-content:center; gap:10px;}
.header p {font-size:1.1rem; color: var(--gray);}
.controls {display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;}
.stats {display:flex; gap:15px; flex-wrap:wrap;}
.stat-card {background:white; padding:15px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); min-width:150px; text-align:center;}
.stat-value {font-size:1.8rem; font-weight:bold;}
.stat-label {font-size:0.9rem; color:var(--gray);}
.btn {padding:10px 20px; font-size:1rem; font-weight:600; border:none; border-radius: var(--border-radius); cursor:pointer; transition: var(--transition); display:inline-flex; align-items:center; justify-content:center; gap:8px;}
.btn-primary {background: var(--primary); color:white;}
.btn-primary:hover {background: var(--primary-dark);}
.btn-secondary {background: var(--light); color: var(--dark); border:1px solid #dee2e6;}
.btn-secondary:hover {background:#e9ecef;}
.table-container {background:white; border-radius: var(--border-radius); box-shadow: var(--box-shadow); overflow:hidden;}
table {width:100%; border-collapse:collapse;}
thead {background:var(--light);}
th {padding:15px; text-align:left; font-weight:600; border-bottom:2px solid #dee2e6;}
td {padding:12px 15px; border-bottom:1px solid #e9ecef;}
tr:last-child td {border-bottom:none;}
tr:hover {background:#f8f9fa;}
.status-badge {padding:5px 10px; border-radius:20px; font-size:0.8rem; font-weight:600; text-transform:uppercase;}
.status-pass {background: rgba(40,167,69,0.1); color: var(--success);}
.status-fail {background: rgba(220,53,69,0.1); color: var(--danger);}
.status-skipped {background: rgba(255,193,7,0.1); color: var(--warning);}
.loading {text-align:center; padding:40px;}
.spinner {border:4px solid rgba(0,0,0,0.1); border-left-color: var(--primary); border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto 20px;}
@keyframes spin {to {transform:rotate(360deg);}}
.empty-state {text-align:center; padding:40px; color: var(--gray);}
.footer {text-align:center; margin-top:30px; color: var(--gray); font-size:0.9rem;}
@media (max-width:768px){.controls{flex-direction:column; align-items:stretch;}.stats{justify-content:center;} th,td{padding:8px 10px; font-size:0.9rem;} .table-container{overflow-x:auto;}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üõ† Taisen Debug Dashboard</h1>
    <p>App, network, performance, and CAPTCHA verification logs</p>
  </div>

  <!-- Controls & Stats -->
  <div class="controls">
    <div class="stats" id="statsContainer">
      <div class="stat-card"><div class="stat-value" id="totalLogs">0</div><div class="stat-label">Total Logs</div></div>
      <div class="stat-card"><div class="stat-value" id="passCount">0</div><div class="stat-label">Successful</div></div>
      <div class="stat-card"><div class="stat-value" id="failCount">0</div><div class="stat-label">Failed</div></div>
      <div class="stat-card"><div class="stat-value" id="skipCount">0</div><div class="stat-label">Skipped</div></div>
      <div class="stat-card"><div class="stat-value" id="pageLoadTime">0 ms</div><div class="stat-label">Dashboard Load</div></div>
      <div class="stat-card"><div class="stat-value" id="indexLoadTime">0 ms</div><div class="stat-label">Index Page Load</div></div>
      <div class="stat-card"><div class="stat-value" id="resultsLoadTime">0 ms</div><div class="stat-label">Results Page Load</div></div>
    </div>
    <div>
      <button id="refreshBtn" class="btn btn-primary">üîÑ Refresh</button>
      <button id="triggerDummySearch" class="btn btn-primary">‚ö° Dummy Search</button>
      <button id="resetAppState" class="btn btn-secondary">‚ôª Reset App State</button>
      <a href="index.html" class="btn btn-secondary">‚Üê Back to Verification</a>
    </div>
  </div>

  <!-- CAPTCHA Logs Table -->
  <div class="table-container">
    <table id="captchaTable">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Query</th>
          <th>Status</th>
          <th>Info</th>
          <th>Attempts</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="5" class="loading"><div class="spinner"></div><p>Loading CAPTCHA logs...</p></td></tr>
      </tbody>
    </table>
  </div>

  <!-- App & Environment Info -->
  <div class="table-container" style="margin-top:20px;">
    <table>
      <thead>
        <tr><th>App Info</th><th>Value</th></tr>
      </thead>
      <tbody>
        <tr><td>Version / Build</td><td id="appVersion">1.9.0</td></tr>
        <tr><td>Environment</td><td id="appEnv">Production</td></tr>
        <tr><td>Feature Flags</td><td id="featureFlags">Default</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Footer -->
  <div class="footer">
    <p>Taisen Security System &copy; 2023</p>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBZQarXeg-km3dY8vuEN3FffzWtwzkZDuk",
  authDomain: "taisenlogs.firebaseapp.com",
  projectId: "taisenlogs",
  storageBucket: "taisenlogs.firebasestorage.app",
  messagingSenderId: "404806925329",
  appId: "1:404806925329:web:c74775ebb199bf40c085b0",
  measurementId: "G-6JQNJXVTLT"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const analytics = getAnalytics(app);

// DOM elements
const tableBody = document.getElementById('tableBody');
const refreshBtn = document.getElementById('refreshBtn');
const totalLogsEl = document.getElementById('totalLogs');
const passCountEl = document.getElementById('passCount');
const failCountEl = document.getElementById('failCount');
const skipCountEl = document.getElementById('skipCount');

const pageLoadTimeEl = document.getElementById('pageLoadTime');
const indexLoadTimeEl = document.getElementById('indexLoadTime');
const resultsLoadTimeEl = document.getElementById('resultsLoadTime');

// Simple log system
let logs = [];
function log(type, message){ logs.push({type,message,time:new Date().toLocaleTimeString()}); console[type==='error'?'error':'log'](message); }

// Measure latency for pages
async function measurePageLoad(url){
  const start = performance.now();
  try {
    const response = await fetch(url,{cache:"no-store"});
    if(!response.ok) throw new Error(`Status ${response.status}`);
    await response.text();
    const end = performance.now();
    return (end-start).toFixed(2);
  } catch(e){ log('error', `Failed to fetch ${url}: ${e.message}`); return 'Error'; }
}
async function updatePageLatencies(){
  indexLoadTimeEl.textContent = `${await measurePageLoad('index.html')} ms`;
  resultsLoadTimeEl.textContent = `${await measurePageLoad('results.html')} ms`;
}

// CAPTCHA Logs
async function loadCaptchaLogs(){
  tableBody.innerHTML = `<tr><td colspan="5" class="loading"><div class="spinner"></div><p>Loading CAPTCHA logs...</p></td></tr>`;
  resetStats();
  try{
    const q = query(collection(db,"captchaLogs"), orderBy("timestamp","desc"));
    const snapshot = await getDocs(q);
    if(snapshot.empty){ tableBody.innerHTML=`<tr><td colspan="5" class="empty-state">No logs found. Try a verification.</td></tr>`; return;}
    tableBody.innerHTML='';
    snapshot.forEach(doc=>{
      const logData = doc.data(); addLogToTable(logData); updateStats(logData.status);
    });
  }catch(err){
    console.error("Error loading logs:", err);
    tableBody.innerHTML=`<tr><td colspan="5" class="empty-state">Error: ${err.message}</td></tr>`;
  }
}
function addLogToTable(logData){
  const tr = document.createElement("tr");
  const timestamp = new Date(logData.timestamp).toLocaleString();
  const statusBadge = document.createElement("span");
  statusBadge.className=`status-badge status-${logData.status}`;
  statusBadge.textContent = logData.status.toUpperCase();
  tr.innerHTML=`<td>${timestamp}</td><td>${logData.query||"N/A"}</td><td></td><td>${logData.info}</td><td>${logData.attempts}</td>`;
  tr.cells[2].appendChild(statusBadge);
  tableBody.appendChild(tr);
}
function resetStats(){ totalLogsEl.textContent="0"; passCountEl.textContent="0"; failCountEl.textContent="0"; skipCountEl.textContent="0";}
function updateStats(status){
  totalLogsEl.textContent=parseInt(totalLogsEl.textContent)+1;
  if(status==="pass") passCountEl.textContent=parseInt(passCountEl.textContent)+1;
  else if(status==="fail") failCountEl.textContent=parseInt(failCountEl.textContent)+1;
  else if(status==="skipped") skipCountEl.textContent=parseInt(skipCountEl.textContent)+1;
}

// Dummy search trigger
function triggerDummySearch(){ log('info','Dummy search triggered'); alert('Dummy search triggered.'); }

// Reset app state
function resetAppState(){ logs=[]; loadCaptchaLogs(); updatePageLatencies(); alert('App state reset'); log('info','App state reset'); }

document.addEventListener('DOMContentLoaded',()=>{
  loadCaptchaLogs();
  updatePageLatencies();
  refreshBtn.addEventListener('click', loadCaptchaLogs);
  document.getElementById('triggerDummySearch').addEventListener('click', triggerDummySearch);
  document.getElementById('resetAppState').addEventListener('click', resetAppState);
  const loadTime = performance.now().toFixed(2); pageLoadTimeEl.textContent=`${loadTime} ms`; log('info',`Dashboard loaded in ${loadTime} ms`);
});
</script>
</body>
</html>
